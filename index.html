<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚µãƒ¼ãƒãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .menu-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .project-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .search-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .search-options {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .researcher-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .researcher-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .researcher-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .researcher-info {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .ai-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .expanded-keywords {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .keyword-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.85em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .score-badge {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .young-researcher-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .young-researcher-info {
            background: #fff5f5;
            border-left: 4px solid #ff6b6b;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #c53030;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            border-top: 1px solid #e9ecef;
            margin-top: 40px;
        }
        .history-tag {
            display: inline-flex; /* å†…éƒ¨è¦ç´ ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãŸã‚ */
            align-items: center;  /* å‚ç›´æ–¹å‘ä¸­å¤®æƒãˆ */
            background: #e9ecef;
            color: #495057;
            padding: 4px 6px 4px 12px; /* å‰Šé™¤ãƒœã‚¿ãƒ³ç”¨ã«å³å´ã®ä½™ç™½ã‚’èª¿æ•´ */
            border-radius: 15px;
            margin: 4px 2px;
            font-size: 0.85em;
            transition: background-color 0.2s;
            border: 1px solid #dee2e6;
        }
        .history-tag:hover {
            background: #dee2e6;
            border-color: #adb5bd;
        }
        .history-keyword {
            cursor: pointer;
            margin-right: 4px; /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®é–“éš” */
        }
        .delete-history-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            padding: 2px 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .delete-history-btn:hover {
            color: #333;
            background-color: rgba(0,0,0,0.1);
        }

        /* AIåˆ†æçµæœã‚¨ãƒªã‚¢ç”¨ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .ai-analysis-content h1,
        .ai-analysis-content h2,
        .ai-analysis-content h3,
        .ai-analysis-content h4,
        .ai-analysis-content h5,
        .ai-analysis-content h6 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }
        
        .ai-analysis-content h1 { font-size: 24px; }
        .ai-analysis-content h2 { font-size: 20px; }
        .ai-analysis-content h3 { font-size: 18px; }
        .ai-analysis-content h4 { font-size: 16px; }
        .ai-analysis-content h5 { font-size: 14px; }
        .ai-analysis-content h6 { font-size: 12px; }
        
        .ai-analysis-content p {
            margin: 10px 0;
            line-height: 1.7;
        }
        
        .ai-analysis-content ul,
        .ai-analysis-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        .ai-analysis-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .ai-analysis-content code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .ai-analysis-content strong {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .ai-analysis-content em {
            font-style: italic;
            color: #495057;
        }
        
        .ai-analysis-content hr {
            margin: 25px 0;
            border: none;
            border-top: 2px solid #e9ecef;
        }
        
        .ai-analysis-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-bottom-color 0.3s ease;
        }
        
        .ai-analysis-content a:hover {
            border-bottom-color: #667eea;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-markdown-content h1,
        .modal-markdown-content h2,
        .modal-markdown-content h3,
        .modal-markdown-content h4,
        .modal-markdown-content h5,
        .modal-markdown-content h6 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }
        
        .modal-markdown-content h1 { font-size: 22px; }
        .modal-markdown-content h2 { font-size: 18px; }
        .modal-markdown-content h3 { font-size: 16px; }
        .modal-markdown-content h4 { font-size: 14px; }
        .modal-markdown-content h5 { font-size: 13px; }
        .modal-markdown-content h6 { font-size: 12px; }
        
        .modal-markdown-content p {
            margin: 10px 0;
            line-height: 1.7;
        }
        
        .modal-markdown-content ul,
        .modal-markdown-content ol {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .modal-markdown-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .modal-markdown-content code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
        }
        
        .modal-markdown-content strong {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .modal-markdown-content em {
            font-style: italic;
            color: #495057;
        }
        .filter-active-badge {
            display: inline-block;
            background-color: #e3f2fd;
            color: #0c5460;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 5px 5px 5px 0;
            font-size: 0.9em;
            font-weight: 500;
            border: 1px solid #bee5eb;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 8px;
        }
        .pagination button {
            background: white;
            border: 1px solid #dee2e6;
            color: #667eea;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pagination button:hover {
            background-color: #f8f9fa;
            border-color: #667eea;
        }
        .pagination button.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
<div class="sidebar">
            <h1>ğŸ¤ ãƒªã‚µãƒ¼ãƒãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h1>
            <hr style="border-color: rgba(255,255,255,0.3); margin: 20px 0;">
            
            <div class="menu-item active" style="cursor: default;">
                ğŸ” ç ”ç©¶è€…æ¤œç´¢
            </div>
            <a href="researcher-analysis.html" class="menu-item">
                ğŸ“‚ ä¿å­˜æ¸ˆã¿åˆ†æ
            </a>
            <a href="project.html" class="menu-item">
                ğŸ“Š ãƒã‚¤ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
            </a>
            <hr style="border-color: rgba(255,255,255,0.3); margin: 20px 0;">
            
            <div class="project-info">
                <h4>é€²è¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä¾‹ï¼‰</h4>
                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; margin-top: 10px;">
                    é€²è¡Œä¸­: æ¬¡ä¸–ä»£AIææ–™æ¢ç´¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
                </div>
            </div>
            
            <button class="logout-btn" onclick="showLogoutMessage()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div class="main-content">
            <div id="researchers-page" class="page">
                <div class="header">
                    <h1>ğŸ” ç ”ç©¶è€…æ¤œç´¢</h1>
                    <p>25ä¸‡äººè¶…ã®ç ”ç©¶è€…ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã€AIã¨å°‚é–€ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆãŒè²´ç¤¾ã«æœ€é©ãªç ”ç©¶è€…ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>
                </div>

                <div class="search-section">
                    <div id="api-status" class="alert alert-info" style="display: none;"></div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <a href="researcher-analysis.html" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 10px;">
                            ğŸ“‚ ä¿å­˜æ¸ˆã¿åˆ†æçµæœã‚’ç®¡ç†
                        </a>
                        <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">éå»ã®AIåˆ†æçµæœã‚’é–²è¦§ãƒ»ç®¡ç†ã§ãã¾ã™</p>
                    </div>
                    
                    <hr style="margin: 20px 0; border-color: #e9ecef;">
                    
                    <div id="university-filter-section" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">ğŸ« å¤§å­¦åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</h4>
                        <div class="form-group">
                            <input type="text" id="university-search-input" class="form-control" 
                                   placeholder="å¤§å­¦åã‚’æ¤œç´¢..." oninput="displayUniversityList()">
                        </div>
                        <div id="university-list-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                            
                        </div>
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn btn-secondary" onclick="selectAllUniversities()" style="font-size: 14px;">å…¨ã¦é¸æŠ</button>
                            <button class="btn btn-secondary" onclick="clearUniversityFilter()" style="font-size: 14px;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                    
                    <div class="search-options">
                        <h3 style="margin-bottom: 15px;">è©³ç´°æ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                        
                        <div class="form-group">
                            <label>æ¤œç´¢æ–¹æ³•</label>
                            <select class="form-control" id="search-method">
                                <option value="semantic">ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ï¼ˆæ¨å¥¨ï¼‰</option>
                                <option value="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="llm-expansion">
                            <label for="llm-expansion">ğŸ§  AIã«ã‚ˆã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µ</label>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="young-researcher-filter">
                            <label for="young-researcher-filter">ğŸŒŸ è‹¥æ‰‹ç ”ç©¶è€…ã®ã¿è¡¨ç¤º</label>
                        </div>

                        <div class="form-group">
                            <label for="api-search-input">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="text" class="form-control" id="api-search-input" placeholder="ä¾‹: äººå·¥çŸ¥çŸ¥èƒ½ã€å†ç”ŸåŒ»ç™‚ã€ãƒŠãƒææ–™ã€ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«">
                            <div id="search-history-container" style="margin-top: 8px; min-height: 28px;"></div>
                        </div>

                        <div class="form-group">
                            <label for="exclude-keywords-input">é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒã‚„ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label>
                            <input type="text" class="form-control" id="exclude-keywords-input" placeholder="ä¾‹: å‹•ç‰©å®Ÿé¨“, å€«ç†å•é¡Œ">
                            <div id="exclude-history-container" style="margin-top: 8px; min-height: 28px;"></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="performAPISearch()" style="flex: 1;">
                                ğŸš€ ç ”ç©¶è€…ã‚’æ¤œç´¢
                            </button>
                            <button class="btn btn-secondary" onclick="clearSearchAndResults()" style="width: 120px;">
                                ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                    
                    <div id="api-search-results" style="margin-top: 20px;">
                        <div class="alert alert-info">
                            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œç ”ç©¶è€…ã‚’æ¤œç´¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>


                </div>
            </div>

            <div class="footer">
                Â© 2025 Your Company Name. All Rights Reserved. | ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚
            </div>
        </div>
    </div>

    <div id="project-select-modal" class="project-select-modal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    ">
        <div class="project-select-content" style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        ">
            <div class="project-select-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #e9ecef;
            ">
                <h3>ç ”ç©¶è€…ã‚’è¿½åŠ ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</h3>
                <button class="project-select-close" onclick="closeProjectSelectModal()" style="
                    background: #e9ecef;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                ">âœ•</button>
            </div>
            
            <div class="create-project-option" onclick="createNewProjectFromModal()" style="
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                text-align: center;
                padding: 20px;
                border-radius: 8px;
                cursor: pointer;
                margin-bottom: 20px;
                transition: all 0.3s ease;
            ">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                    â• æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                </div>
                <div style="font-size: 14px; opacity: 0.9;">
                    æ–°ã—ã„ä»®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ç ”ç©¶è€…ã‚’è¿½åŠ 
                </div>
            </div>
            
            <div id="project-list-container">
                </div>
            
            <div class="project-select-actions" style="
                margin-top: 25px;
                padding-top: 20px;
                border-top: 2px solid #e9ecef;
                display: flex;
                gap: 15px;
                justify-content: flex-end;
            ">
                <button class="btn btn-secondary" onclick="closeProjectSelectModal()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="add-to-project-btn" class="btn btn-primary" onclick="addResearcherToSelectedProject()" disabled>
                    é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <script>
        /**
         * ä¿å­˜æ¸ˆã¿ã®åˆ†æçµæœã®URLã¨IDã®å¯¾å¿œãƒãƒƒãƒ—ã‚’å–å¾—ã™ã‚‹
         * @returns {Map<string, string>} researchmap_urlã‚’ã‚­ãƒ¼ã€analysis_idã‚’å€¤ã¨ã™ã‚‹Map
         */
        function getSavedUrlToIdMap() {
            try {
                const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
                const urlMap = new Map();
                for (const analysis of savedAnalyses) {
                    // URLã¨åˆ†æIDã®ä¸¡æ–¹ãŒã‚ã‚‹å ´åˆã®ã¿ãƒãƒƒãƒ—ã«è¿½åŠ 
                    if (analysis.researchmap_url && analysis.analysis_id) {
                        urlMap.set(analysis.researchmap_url, analysis.analysis_id);
                    }
                }
                return urlMap;
            } catch (e) {
                console.error("ä¿å­˜æ¸ˆã¿åˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
                return new Map();
            }
        }
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å…ˆé ­ã«è¿½åŠ 
        const MAX_HISTORY_COUNT = 5;
        const SEARCH_HISTORY_KEY = 'researcherSearchHistory';
        const EXCLUDE_HISTORY_KEY = 'researcherExcludeHistory';
        let fullSearchResults = [];
        let currentPage = 1;
        const resultsPerPage = 20;
        let activeUniversityFilters = []; // â† ã“ã®è¡Œã‚’è¿½åŠ 
        
        // api-client.jsã§å®šç¾©ã•ã‚ŒãŸapiClientã‚’ä½¿ç”¨
        
        // å¤§å­¦ãƒªã‚¹ãƒˆã‚’ä¿æŒ
        window.universityList = [];
        window.selectedUniversities = [];
        
        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function convertMarkdownToHtml(text) {
            if (!text) return '';
            
            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®å¤‰æ›
            html = html
                // è¦‹å‡ºã—ï¼ˆh1-h6ï¼‰
                .replace(/^######\s+(.+)$/gm, '<h6>$1</h6>')
                .replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>')
                .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>')
                .replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
                .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
                .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>')
                
                // å¤ªå­—
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.+?)__/g, '<strong>$1</strong>')
                
                // æ–œä½“
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                
                // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
                .replace(/`(.+?)`/g, '<code style="background-color: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                
                // æ°´å¹³ç·š
                .replace(/^---+$/gm, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e9ecef;">')
                .replace(/^___+$/gm, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e9ecef;">')
                .replace(/^\*\*\*+$/gm, '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e9ecef;">')
                
                // ãƒªãƒ³ã‚¯
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: none;">$1</a>')
                
                // ç•ªå·ä»˜ããƒªã‚¹ãƒˆ
                .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
                
                // ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ
                .replace(/^[-*+]\s+(.+)$/gm, '<li>$1</li>')
                
                // æ”¹è¡Œã‚’<br>ã«å¤‰æ›ï¼ˆæ®µè½ã®åŒºåˆ‡ã‚Šã¯ä¿æŒï¼‰
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // ãƒªã‚¹ãƒˆã®å‡¦ç†
            html = html.replace(/(<li>.*?<\/li>)/gs, function(match) {
                if (!match.includes('<ol>') && !match.includes('<ul>')) {
                    if (match.match(/^\d+\./)) {
                        return '<ol style="margin: 10px 0; padding-left: 30px;">' + match + '<\/ol>';
                    } else {
                        return '<ul style="margin: 10px 0; padding-left: 30px;">' + match + '<\/ul>';
                    }
                }
                return match;
            });
            
            // æ®µè½ã®å‡¦ç†
            if (!html.startsWith('<')) {
                html = '<p>' + html + '<\/p>';
            }
            
            return html;
        }
                /**
         * è·é›¢ï¼ˆdistanceï¼‰ã«åŸºã¥ã„ã¦é–¢é€£åº¦ã‚’åˆ†é¡ã™ã‚‹
         * @param {number} distance - ã‚³ã‚µã‚¤ãƒ³è·é›¢
         * @returns {{label: string, color: string}} - é–¢é€£åº¦ã®ãƒ©ãƒ™ãƒ«ã¨è‰²ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function classifyRelevanceByDistance(distance) {
            // ã—ãã„å€¤ã¯æ¤œç´¢çµæœã‚’è¦‹ãªãŒã‚‰èª¿æ•´ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™
            if (distance < 0.3) {
                return { label: 'é«˜', color: '#28a745' }; // ç·‘è‰²
            } else if (distance < 0.4) {
                return { label: 'ä¸­', color: '#ffc107' }; // é»„è‰²
            } else {
                return { label: 'ä½', color: '#6c757d' }; // ã‚°ãƒ¬ãƒ¼
            }
        }

        // æ¤œç´¢æ–¹æ³•å¤‰æ›´æ™‚ã®å‡¦ç†
        window.onSearchMethodChange = function() {
            const searchMethod = document.getElementById('search-method').value;
            const llmExpansionCheckbox = document.getElementById('llm-expansion');
            const llmExpansionLabel = llmExpansionCheckbox.parentElement.querySelector('label');
            
            if (searchMethod === 'semantic') {
                // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã®å ´åˆã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µã‚’ç„¡åŠ¹åŒ–
                llmExpansionCheckbox.disabled = true;
                llmExpansionCheckbox.checked = false;
                llmExpansionLabel.style.opacity = '0.5';
                llmExpansionLabel.title = 'ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢æ™‚ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“';
            } else {
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã®å ´åˆã¯æœ‰åŠ¹åŒ–
                llmExpansionCheckbox.disabled = false;
                llmExpansionLabel.style.opacity = '1';
                llmExpansionLabel.title = '';
            }
        }
        
        // AIé–¢é€£æ€§åˆ†æãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
        window.onLLMSummaryChange = function() {
            const llmSummaryCheckbox = document.getElementById('llm-summary');
            // AIé–¢é€£æ€§åˆ†æãŒONã®å ´åˆã€è‡ªå‹•çš„ã«å†…éƒ¨è©•ä¾¡ã‚’ä½¿ç”¨
        }

        // å†…éƒ¨è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã®çµæœè¡¨ç¤ºé–¢æ•°
        window.displayInternalEvaluationResults = function(apiResponse) {
            const resultsContainer = document.getElementById('api-search-results');
            
            // ã¾ãšé€šå¸¸ã®æ¤œç´¢çµæœã‚’è¡¨ç¤ºï¼ˆresultsãŒã‚ã‚‹å ´åˆï¼‰
            let html = '';
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            html += `
                <div class="alert alert-success">
                    ã€Œ${apiResponse.query}ã€ã®${apiResponse.method === 'semantic' ? 'ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯' : 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'}æ¤œç´¢çµæœ: 
                    ${apiResponse.total}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚
                    <small>(å®Ÿè¡Œæ™‚é–“: ${apiResponse.execution_time.toFixed(2)}ç§’)</small>
                </div>
            `;
            
            // ãƒ‡ãƒãƒƒã‚°ï¼šAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“ã‚’ç¢ºèª
            console.log('ğŸ” APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:', apiResponse);
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µæƒ…å ±ã®è¡¨ç¤º
            if (apiResponse.expanded_info && apiResponse.expanded_info.expanded_keywords) {
                const expandedKeywords = apiResponse.expanded_info.expanded_keywords;
                html += `
                    <div class="expanded-keywords">
                        <strong>ğŸ§  AIã«ã‚ˆã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µ:</strong><br>
                        <div style="margin-top: 8px;">
                            ${expandedKeywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // é€šå¸¸ã®æ¤œç´¢çµæœã‚’è¡¨ç¤ºï¼ˆresultsãŒã‚ã‚‹å ´åˆï¼‰
            if (apiResponse.results && apiResponse.results.length > 0) {
                apiResponse.results.forEach((researcher) => {
                    const name = researcher.name_ja || researcher.name_en || 'åå‰ä¸æ˜';
                    const affiliation = researcher.main_affiliation_name_ja || researcher.main_affiliation_name_en || 'æ‰€å±ä¸æ˜';
                    const keywords = researcher.research_keywords_ja || 'N/A';
                    const fields = researcher.research_fields_ja || 'N/A';
                    const profile = researcher.profile_ja || 'N/A';
                    const paper = researcher.paper_title_ja_first || 'N/A';
                    const project = researcher.project_title_ja_first || 'N/A';
                    const researchmapUrl = researcher.researchmap_url || '#';
                    // ã€Œè¿½åŠ æ¸ˆã€ãƒ©ãƒ™ãƒ«ç”¨ã®HTMLã‚’æº–å‚™
                    const addedProjectName = addedResearchersMap.get(researchmapUrl);
                    let addedProjectLabelHtml = '';
                    if (addedProjectName) {
                        addedProjectLabelHtml = `
                            <div class="project-added-label" style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600; font-size: 14px; margin-top: 15px;">
                                âœ…ã€Œ${addedProjectName}ã€ã«è¿½åŠ æ¸ˆã§ã™
                            </div>
                        `;
                    }

                    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã¨é–¢é€£åº¦ãƒãƒƒã‚¸
                    let scoreText = '';
                    let relevanceBadgeHtml = ''; // ãƒãƒƒã‚¸ç”¨ã®å¤‰æ•°ã‚’è¿½åŠ 

                    if (apiResponse.method === 'keyword' && researcher.relevance_score !== null) {
                        scoreText = ` (é–¢é€£åº¦: ${researcher.relevance_score})`;
                    } else if (apiResponse.method === 'semantic' && researcher.distance !== null) {
                        // ã‚¹ãƒ†ãƒƒãƒ—1ã§ä½œæˆã—ãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã—
                        const relevance = classifyRelevanceByDistance(researcher.distance);
                        // ãƒãƒƒã‚¸ã®HTMLã‚’ç”Ÿæˆ
                        relevanceBadgeHtml = `
                            <span style="
                                display: inline-block;
                                background-color: ${relevance.color};
                                color: white;
                                padding: 3px 10px;
                                border-radius: 12px;
                                font-size: 0.8em;
                                font-weight: bold;
                                margin-left: 10px;
                            ">
                                é–¢é€£åº¦: ${relevance.label}
                            </span>`;
                        scoreText = ` (è·é›¢: ${researcher.distance.toFixed(4)})`; // è·é›¢ã®æ•°å€¤ã‚‚æ®‹ã™
                    }

                    html += `
                        <div class="researcher-card">
                            <div class="researcher-name">${name} (${affiliation})${scoreText}${relevanceBadgeHtml}</div>
                            
                            ${keywords !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ç ”ç©¶ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</span> ${keywords}</div>` : ''}
                            ${fields !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ç ”ç©¶åˆ†é‡:</span> ${fields}</div>` : ''}
                            ${profile !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:</span> ${profile.length > 200 ? profile.substring(0, 200) + '...' : profile}</div>` : ''}
                            ${paper !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ä¸»è¦è«–æ–‡:</span> ${paper}</div>` : ''}
                            ${project !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ä¸»è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span> ${project}</div>` : ''}
                            
                            ${researcher.llm_summary ? `
                                <div class="ai-summary">
                                    <strong>AIé–¢é€£æ€§åˆ†æ:</strong> 
                                    <div class="ai-analysis-content">${convertMarkdownToHtml(researcher.llm_summary)}</div>
                                </div>
                            ` : ''}
                            
                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="showResearcherDetail('${name}')">è©³ç´°ã‚’è¦‹ã‚‹</button>
                                <button class="btn btn-primary" onclick="addToProjectCandidates('${name}', '${affiliation}', '${researchmapUrl}')">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå€™è£œã«è¿½åŠ </button>
                                ${researchmapUrl !== '#' ? `<a href="${researchmapUrl}" target="_blank" class="btn btn-secondary">ResearchMap</a>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            // è©•ä¾¡çµæœã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼
            if (apiResponse.evaluated_results && apiResponse.evaluated_results.length > 0) {
                html += `
                    <div style="margin-top: 40px; border-top: 3px solid #667eea; padding-top: 30px;">
                        <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ¯ AIé–¢é€£æ€§åˆ†æçµæœ</h2>
                        <div class="alert alert-info">
                            <h4>ãƒ™ã‚¹ãƒˆãƒãƒƒãƒ: ${apiResponse.summary?.best_match || 'è©²å½“ãªã—'}</h4>
                            <p><strong>è©•ä¾¡ã‚µãƒãƒªãƒ¼:</strong> ${apiResponse.summary?.key_finding || ''}</p>
                            <p><small>è©•ä¾¡å®Œäº†: ${apiResponse.total}å | ãƒˆãƒƒãƒ—${apiResponse.displayed}åã‚’è¡¨ç¤º</small></p>
                        </div>
                    </div>
                `;
            }
            
            // è©•ä¾¡çµæœã®è¡¨ç¤º
            if (apiResponse.evaluated_results && apiResponse.evaluated_results.length > 0) {
                apiResponse.evaluated_results.forEach((result) => {
                    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                    console.log('è©•ä¾¡çµæœ:', result);
                    
                    // è‹¥æ‰‹ç ”ç©¶è€…åˆ¤å®šï¼ˆå†…éƒ¨è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å®Ÿæ–½ï¼‰
                    const isYoungResearcher = result.is_young_researcher || false;
                    const youngReasons = result.young_researcher_reasons || [];
                    
                    html += `
                        <div class="researcher-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="researcher-name">
                                    ç¬¬${result.rank}ä½: ${result.name}
                                    ${isYoungResearcher ? '<span class="young-researcher-badge">ğŸŒŸ è‹¥æ‰‹ç ”ç©¶è€…</span>' : ''}
                                </div>
                                <div class="score-badge">ç·åˆã‚¹ã‚³ã‚¢: ${result.score}/10</div>
                            </div>
                            
                            <div class="researcher-info"><span class="info-label">æ‰€å±:</span> ${result.affiliation}</div>
                            <div class="researcher-info"><span class="info-label">ç ”ç©¶ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</span> ${result.keywords || 'N/A'}</div>
                            ${result.fields ? `<div class="researcher-info"><span class="info-label">ç ”ç©¶åˆ†é‡:</span> ${result.fields}</div>` : ''}
                            ${result.profile ? `<div class="researcher-info"><span class="info-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:</span> ${profile.length > 200 ? result.profile.substring(0, 200) + '...' : result.profile}</div>` : ''}
                            ${result.paper_title ? `<div class="researcher-info"><span class="info-label">ä¸»è¦è«–æ–‡:</span> ${result.paper_title}</div>` : ''}
                            ${result.project_title ? `<div class="researcher-info"><span class="info-label">ä¸»è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span> ${result.project_title}</div>` : ''}
                            
                            <div class="ai-summary">
                                <strong>AIé–¢é€£æ€§åˆ†æ:</strong> 
                                <div class="ai-analysis-content">${convertMarkdownToHtml(result.summary)}</div>
                            </div>
                            
                            ${isYoungResearcher && youngReasons.length > 0 ? `
                                <div class="young-researcher-info">
                                    <strong>ğŸŒŸ è‹¥æ‰‹ç ”ç©¶è€…ã®åˆ¤å®šç†ç”±:</strong> ${youngReasons.join('ã€')}
                                </div>
                            ` : ''}
                            
                            ${result.strengths && result.strengths.length > 0 ? `
                                <div class="researcher-info" style="margin-top: 10px;">
                                    <span class="info-label">å¼·ã¿:</span>
                                    ${result.strengths.map(strength => `<span class="keyword-tag" style="background: #4caf50;">${strength}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            ${result.detail_scores ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600;">è©³ç´°ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º</summary>
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="margin-bottom: 8px;"><strong>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´åº¦:</strong> ${result.detail_scores.keyword_match || 'N/A'}/10${result.score_reasons && result.score_reasons.keyword_match ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.keyword_match}</small>` : ''}</div>
                                        <div style="margin-bottom: 8px;"><strong>ç ”ç©¶ã®ç›´æ¥æ€§:</strong> ${result.detail_scores.research_directness || 'N/A'}/10${result.score_reasons && result.score_reasons.research_directness ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.research_directness}</small>` : ''}</div>
                                        <div style="margin-bottom: 8px;"><strong>å°‚é–€æ€§ã®æ·±ã•:</strong> ${result.detail_scores.expertise_depth || 'N/A'}/10${result.score_reasons && result.score_reasons.expertise_depth ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.expertise_depth}</small>` : ''}</div>
                                        <div style="margin-bottom: 8px;"><strong>å…·ä½“çš„å®Ÿç¸¾:</strong> ${result.detail_scores.practical_evidence || 'N/A'}/10${result.score_reasons && result.score_reasons.practical_evidence ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.practical_evidence}</small>` : ''}</div>
                                        <div style="margin-bottom: 8px;"><strong>ç ”ç©¶ã®è³ª:</strong> ${result.detail_scores.research_quality || 'N/A'}/10${result.score_reasons && result.score_reasons.research_quality ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.research_quality}</small>` : ''}</div>
                                        <div style="margin-bottom: 8px;"><strong>å­¦éš›æ€§:</strong> ${result.detail_scores.interdisciplinary || 'N/A'}/10${result.score_reasons && result.score_reasons.interdisciplinary ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.interdisciplinary}</small>` : ''}</div>
                                        <div><strong>æœ€æ–°æ€§:</strong> ${result.detail_scores.recency || 'N/A'}/10${result.score_reasons && result.score_reasons.recency ? `<br><small style="color: #666; margin-left: 20px;">${result.score_reasons.recency}</small>` : ''}</div>
                                    </div>
                                </details>
                            ` : ''}
                            
                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="showResearcherDetail('${result.name}')">è©³ç´°ã‚’è¦‹ã‚‹</button>
                                <button class="btn btn-primary" onclick="addToProjectCandidates('${result.name}', '${result.affiliation}', '${result.url || ''}')">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå€™è£œã«è¿½åŠ </button>
                                ${result.url ? `<a href="${result.url}" target="_blank" class="btn btn-secondary">ResearchMap</a>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            resultsContainer.innerHTML = html;
        }
/**
 * æ‰€å±åã®æ–‡å­—åˆ—ã‚’å¤§å­¦åã«æ­£è¦åŒ–ï¼ˆæ•´å½¢ï¼‰ã™ã‚‹é–¢æ•°
 * @param {string} name - æ•´å½¢ã—ãŸã„å…ƒã®æ‰€å±å
 * @returns {string|null} - æ•´å½¢å¾Œã®å¤§å­¦åã€ã¾ãŸã¯null
 */
function normalizeUniversityName(name) {
    if (!name || typeof name !== 'string') {
        return null;
    }
    let normalized = name;

    // ã€Œå¥ˆè‰¯å…ˆç«¯ç§‘å­¦æŠ€è¡“å¤§å­¦é™¢å¤§å­¦ã€ã‚’ä¾‹å¤–çš„ã«å‡¦ç†
    if (normalized.includes('å¥ˆè‰¯å…ˆç«¯ç§‘å­¦æŠ€è¡“å¤§å­¦é™¢å¤§å­¦')) {
        return 'å¥ˆè‰¯å…ˆç«¯ç§‘å­¦æŠ€è¡“å¤§å­¦é™¢å¤§å­¦';
    }

    // 1. ç‰¹æ®Šãªå¤§å­¦çµ±åˆãƒ«ãƒ¼ãƒ«ã‚’å…ˆã«é©ç”¨
    if (normalized.includes('æ±äº¬å·¥æ¥­å¤§å­¦') || normalized.includes('æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§å­¦')) {
        return 'æ±äº¬ç§‘å­¦å¤§å­¦';
    }
    if (normalized.includes('æ±æµ·å›½ç«‹å¤§å­¦')) {
        return 'åå¤å±‹å¤§å­¦';
    }

    // 2. æ¥é ­è¾ï¼ˆæ³•äººåãªã©ï¼‰ã‚’å‰Šé™¤
    normalized = normalized.replace(/^(å›½ç«‹å¤§å­¦æ³•äºº|å­¦æ ¡æ³•äºº|å…¬ç«‹å¤§å­¦æ³•äºº)\s*/, '');

    // 3. è¤‡æ•°å¤§å­¦åãŒå«ã¾ã‚Œã‚‹å ´åˆã€æœ€åˆã®ã‚‚ã®ã‚’æ¡ç”¨
    normalized = normalized.split('ï¼')[0];

    // 4. å¤§å­¦åä»¥é™ã®çµ„ç¹”åã‚„å½¹è·åã‚’å‰Šé™¤
    normalized = normalized.replace(/\s*(å¤§å­¦é™¢|å¤§å­¦ç—…é™¢|ç—…é™¢|ç ”ç©¶é™¢|ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼|ç ”ç©¶ç§‘|å­¦éƒ¨|é™„å±|ç‰¹ä»»å‡†æ•™æˆ|æ•™æˆ|å‡†æ•™æˆ|å®¢å“¡|æ©Ÿæ§‹|ã‚»ãƒ³ã‚¿ãƒ¼).*$/, '');

    // 5. å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
    normalized = normalized.trim();
    
    // 6. æœ€çµ‚ãƒã‚§ãƒƒã‚¯ï¼ˆã€Œå¤§å­¦ã€ã§çµ‚ã‚ã‚‹ã‹ï¼‰
    if (normalized.endsWith('å¤§å­¦')) {
        return normalized;
    }
    
    return null; // æœ‰åŠ¹ãªå¤§å­¦åã§ãªã„å ´åˆã¯nullã‚’è¿”ã™
}        
        // APIæ¤œç´¢çµæœã®è¡¨ç¤ºé–¢æ•° (å¤§å­¦åæ­£è¦åŒ–å¯¾å¿œç‰ˆ)
window.displayAPISearchResults = function(apiResponse) {
    const resultsContainer = document.getElementById('api-search-results');
    const savedUrlToIdMap = getSavedUrlToIdMap();
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ æ¸ˆã¿ã®ç ”ç©¶è€…æƒ…å ±ã‚’ãƒãƒƒãƒ—åŒ–ã™ã‚‹
    const addedResearchersMap = new Map();
    try {
        const tempProjects = JSON.parse(localStorage.getItem('tempProjects') || '[]');
        tempProjects.forEach(project => {
            if (project.selected_researchers) {
                project.selected_researchers.forEach(researcher => {
                    // researchmap_url ã‚’ã‚­ãƒ¼ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ä¿å­˜
                    if (researcher.url) {
                        addedResearchersMap.set(researcher.url, project.name);
                    }
                });
            }
        });
    } catch (e) {
        console.error("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
    }
    // fullSearchResultsã‹ã‚‰å¤§å­¦ã”ã¨ã®ç ”ç©¶è€…æ•°ã‚’é›†è¨ˆã—ã¾ã™
    const universityCounts = fullSearchResults.reduce((acc, researcher) => {
        const uniName = normalizeUniversityName(researcher.main_affiliation_name_ja || researcher.main_affiliation_name_en);
        if (uniName) {
            acc[uniName] = (acc[uniName] || 0) + 1;
        }
        return acc;
    }, {});
    if (fullSearchResults && fullSearchResults.length > 0) {
        const uniqueUniversities = new Set(
            fullSearchResults.map(r => {
                // ç”Ÿã®æ‰€å±åã‚’æ­£è¦åŒ–é–¢æ•°ã«ã‹ã‘ã‚‹
                return normalizeUniversityName(r.main_affiliation_name_ja || r.main_affiliation_name_en);
            }).filter(Boolean) // nullã«ãªã£ãŸã‚‚ã®ã‚’é™¤å¤–
        );
        window.selectedUniversities = Array.from(uniqueUniversities);
        displayUniversityList(); 
    }
    let resultsToDisplay = fullSearchResults;
    // activeUniversityFiltersã«å¤§å­¦ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€è¡¨ç¤ºçµæœã‚’çµã‚Šè¾¼ã‚€
    if (activeUniversityFilters.length > 0) {
        resultsToDisplay = fullSearchResults.filter(researcher => {
            const uniName = normalizeUniversityName(researcher.main_affiliation_name_ja || researcher.main_affiliation_name_en);
            return uniName && activeUniversityFilters.includes(uniName);
        });
    }
    // (ä»¥é™ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—)
    const totalResults = resultsToDisplay.length;
    const totalPages = Math.ceil(totalResults / resultsPerPage);
    const startIndex = (currentPage - 1) * resultsPerPage;
    const endIndex = startIndex + resultsPerPage;
    const paginatedResults = resultsToDisplay.slice(startIndex, endIndex); // å¤‰æ›´

    let html = '';

if (window.selectedUniversities && window.selectedUniversities.length > 0) {
    // ç ”ç©¶è€…æ•°ã§å¤§å­¦ãƒªã‚¹ãƒˆã‚’é™é †ã«ã‚½ãƒ¼ãƒˆ
    const sortedUniversities = [...window.selectedUniversities].sort((a, b) => {
        return (universityCounts[b] || 0) - (universityCounts[a] || 0);
    });

    html += `
        <div class="alert alert-info" style="margin-bottom: 20px; border-left: 4px solid #667eea;">
            <h5 style="font-size: 16px; color: #2c3e50; margin-bottom: 10px;">ğŸ« å¤§å­¦åˆ¥çµã‚Šè¾¼ã¿ (ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ / Ctrl+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ)</h5>
            <div style="margin-bottom: 10px;">
                ${sortedUniversities.map(univ => {
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ç¾åœ¨ã®å¤§å­¦ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠçŠ¶æ…‹
                    const isSelected = activeUniversityFilters.length === 0 || activeUniversityFilters.includes(univ);
                    const univNameEscaped = univ.replace(/'/g, "\\'"); // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                    
                    return `<span class="filter-active-badge"
                                  onclick="toggleActiveUniversityFilter('${univNameEscaped}', event)"
                                  style="cursor: pointer; transition: all 0.2s; border-width: 2px; ${isSelected ? 'opacity: 1; border-style: solid; font-weight: bold;' : 'opacity: 0.5; border-style: dashed;'}">
                                  ${univ} (${universityCounts[univ] || 0}å)
                            </span>`;
                }).join('')}
            </div>
            ${activeUniversityFilters.length > 0 ? `<button class="btn btn-secondary" onclick="resetActiveUniversityFilter()" style="font-size:12px; padding: 4px 10px;">å…¨å¤§å­¦ã®è¡¨ç¤ºã«æˆ»ã™</button>` : ''}
        </div>
    `;
}

    if (totalResults === 0) {
        html += `<div class="alert alert-info">ã€Œ${apiResponse.query}ã€ã«è©²å½“ã™ã‚‹ç ”ç©¶è€…ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
        resultsContainer.innerHTML = html;
        return;
    }
    
    html += `
        <div class="alert alert-success">
            ã€Œ${apiResponse.query}ã€ã®æ¤œç´¢çµæœ: ${totalResults}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚
            ( ${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤ºä¸­ )
        </div>
    `;

    if (apiResponse.expanded_info && apiResponse.expanded_info.expanded_keywords) {
        const expandedKeywords = apiResponse.expanded_info.expanded_keywords;
        html += `
            <div class="expanded-keywords">
                <strong>ğŸ§  AIã«ã‚ˆã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µ:</strong><br>
                <div style="margin-top: 8px;">
                    ${expandedKeywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                </div>
            </div>
        `;
    }

    paginatedResults.forEach(researcher => {
        const name = researcher.name_ja || researcher.name_en || 'åå‰ä¸æ˜';
        const affiliation = researcher.main_affiliation_name_ja || researcher.main_affiliation_name_en || 'æ‰€å±ä¸æ˜';
        const keywords = researcher.research_keywords_ja || 'N/A';
        const fields = researcher.research_fields_ja || 'N/A';
        const profile = researcher.profile_ja || 'N/A';
        const paper = researcher.paper_title_ja_first || 'N/A';
        const project = researcher.project_title_ja_first || 'N/A';
        const researchmapUrl = researcher.researchmap_url || '#';
        const researcherId = (researchmapUrl.split('/').pop() || (name + affiliation)).replace(/[^a-zA-Z0-9]/g, '');
        const isYoungResearcher = researcher.is_young_researcher;
        const youngReasons = researcher.young_researcher_reasons || [];
        // ã€Œè¿½åŠ æ¸ˆã€ãƒ©ãƒ™ãƒ«ç”¨ã®HTMLã‚’æº–å‚™
        const addedProjectName = addedResearchersMap.get(researchmapUrl);
        let addedProjectLabelHtml = '';
        if (addedProjectName) {
            addedProjectLabelHtml = `
                <div class="project-added-label" style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600; font-size: 14px; margin-top: 15px;">
                    âœ…ã€Œ${addedProjectName}ã€ã«è¿½åŠ æ¸ˆã§ã™
                </div>
            `;
    }
        let relevanceBadgeHtml = '';
        let distanceText = '';
        // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã‹ã¤distanceãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«é–¢é€£åº¦ãƒãƒƒã‚¸ã‚’ç”Ÿæˆ
        if (researcher.distance !== null && researcher.distance !== undefined) {
            const relevance = classifyRelevanceByDistance(researcher.distance);
            relevanceBadgeHtml = `
                <span style="display: inline-block; background-color: ${relevance.color}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-left: 10px;">
                    é–¢é€£åº¦: ${relevance.label}
                </span>`;
            distanceText = ` (è·é›¢: ${researcher.distance.toFixed(4)})`;
        }
        const analysisId = savedUrlToIdMap.get(researchmapUrl);
        
        const analysisButtonHtml = analysisId
            // ä¿å­˜æ¸ˆã¿ã®å ´åˆï¼šã€Œä¿å­˜ã—ãŸåˆ†æçµæœã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            ? `<a href="researcher-analysis.html?id=${analysisId}" class="btn btn-secondary" style="background-color: #d4edda; border-color: #155724; color: #155724;">ğŸ“‚ ä¿å­˜ã—ãŸåˆ†æçµæœ</a>`
            // onclickã«é–¢æ•°å¼•æ•°ã¨ã—ã¦ researcherId ã‚’è¿½åŠ ã—ã€data-actionå±æ€§ã‚’è¿½åŠ 
            : `<button class="btn btn-primary" data-action="analyze" onclick="analyzeResearcherDetail('${researcherId}', '${researchmapUrl}', '${apiResponse.query}', ${JSON.stringify({name: name, affiliation: affiliation}).replace(/"/g, '&quot;')})">ğŸ” AIè©³ç´°åˆ†æ</button>`;           
        
        // --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ä¿®æ­£ â–¼â–¼â–¼ ---
        // JSON.stringifyã§researcherã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ¸¡ã™ã€‚
        // HTMLå±æ€§å†…ã§ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€JSONå†…ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¯ &apos; ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
        const researcherJsonString = JSON.stringify(researcher).replace(/'/g, "&apos;");

        html += `
            <div class="researcher-card" id="card-${researcherId}">
                <div class="researcher-name">
                     ${name} (${affiliation})${distanceText}${relevanceBadgeHtml}
                    ${isYoungResearcher ? '<span class="young-researcher-badge">ğŸŒŸ è‹¥æ‰‹ç ”ç©¶è€…</span>' : ''}
                </div>
                
                ${keywords !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ç ”ç©¶ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</span> ${keywords}</div>` : ''}
                ${fields !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ç ”ç©¶åˆ†é‡:</span> ${fields}</div>` : ''}
                ${profile !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:</span> ${profile.length > 200 ? profile.substring(0, 200) + '...' : profile}</div>` : ''}
                ${paper !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ä¸»è¦è«–æ–‡:</span> ${paper}</div>` : ''}
                ${project !== 'N/A' ? `<div class="researcher-info"><span class="info-label">ä¸»è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span> ${project}</div>` : ''}
                
                ${isYoungResearcher && youngReasons.length > 0 ? `
                    <div class="young-researcher-info">
                        <strong>ğŸŒŸ è‹¥æ‰‹ç ”ç©¶è€…ã®åˆ¤å®šç†ç”±:</strong> ${youngReasons.join('ã€')}
                    </div>
                ` : ''}

                <div id="summary-container-${researcherId}" class="ai-summary" style="display: none; margin-top: 15px;"></div>
                
                ${addedProjectLabelHtml}
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick='generateSingleSummary(this, ${researcherJsonString})'>ğŸ¤– AIè¦ç´„ã‚’ç”Ÿæˆ</button>
                    
                    ${analysisButtonHtml} 
                    
                   <button class="btn btn-primary" onclick="addToProjectCandidates('${researcherId}', '${name}', '${affiliation}', '${researchmapUrl}')">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå€™è£œã«è¿½åŠ </button>
                    
                    ${researchmapUrl !== '#' ? `<a href="${researchmapUrl}" target="_blank" class="btn btn-secondary">ResearchMap</a>` : ''}
                </div>
            </div>
        `;
    });
    // --- â–²â–²â–² ã“ã“ã¾ã§ä¿®æ­£ â–²â–²â–² ---

    if (totalPages > 1) {
        html += '<div class="pagination">';
        html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; å‰ã¸</button>`;
        for (let i = 1; i <= totalPages; i++) {
            html += `<button onclick="changePage(${i})" class="${currentPage === i ? 'active' : ''}">${i}</button>`;
        }
        html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>æ¬¡ã¸ &raquo;</button>`;
        html += '<\/div>';
    }

    resultsContainer.innerHTML = html;
};
/**
 * ãƒšãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã®é–¢æ•°
 * @param {number} page - è¡¨ç¤ºã—ãŸã„ãƒšãƒ¼ã‚¸ç•ªå·
 */
window.changePage = function(page) {
    currentPage = page;
    // apiResponseã¯æ¤œç´¢ã‚¯ã‚¨ãƒªã•ãˆã‚ã‚Œã°OK
    displayAPISearchResults({ query: document.getElementById('api-search-input').value.trim() }); 
    document.getElementById('api-search-results').scrollIntoView({ behavior: 'smooth' });
};

// --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰é–¢æ•°å…¨ä½“ã‚’ä¿®æ­£ â–¼â–¼â–¼ ---
/**
 * ç ”ç©¶è€…1ååˆ†ã®AIè¦ç´„ã‚’å€‹åˆ¥ã«ç”Ÿæˆã™ã‚‹é–¢æ•°
 * @param {HTMLElement} buttonElement - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³è¦ç´ 
 * @param {object} researcher - ç ”ç©¶è€…æƒ…å ±ã®å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
async function generateSingleSummary(buttonElement, researcher) {
    // researcherIdã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å†ç”Ÿæˆã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ç‰¹å®š
    const researcherId = (researcher.researchmap_url.split('/').pop() || (researcher.name_ja + researcher.main_affiliation_name_ja)).replace(/[^a-zA-Z0-9]/g, '');
    const container = document.getElementById(`summary-container-${researcherId}`);
    
    // ç¾åœ¨ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’å–å¾—
    const query = document.getElementById('api-search-input').value.trim();

    if (!container || !researcher.researchmap_url || researcher.researchmap_url === '#') {
        alert('ã“ã®ç ”ç©¶è€…ã®è¦ç´„ã¯ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚');
        return;
    }

    container.style.display = 'block';
    container.innerHTML = `<strong>ğŸ¤– AIè¦ç´„ã‚’ç”Ÿæˆä¸­...</strong><div class="spinner" style="width: 15px; height: 15px; margin: 10px auto 0;"></div>`;
    buttonElement.disabled = true;
    buttonElement.textContent = 'ç”Ÿæˆä¸­...';

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã™ã‚‹ãŸã‚ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
    const researcherInfoForPayload = {
        name_ja: researcher.name_ja,
        research_fields_ja: researcher.research_fields_ja,
        project_title_ja_first: researcher.project_title_ja_first,
        paper_title_ja_first: researcher.paper_title_ja_first,
        research_keywords_ja: researcher.research_keywords_ja,
        profile_ja: researcher.profile_ja,
        main_affiliation_name_ja: researcher.main_affiliation_name_ja
    };

    try {
        const response = await fetch(`${apiClient.baseURL}/api/generate-summary`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                researchmap_url: researcher.researchmap_url,
                query: query,
                // researcher_infoãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã€ç”»é¢è¡¨ç¤ºç”¨ã®æƒ…å ±ã‚’è©°ã‚ã¦é€ä¿¡
                researcher_info: researcherInfoForPayload
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ã€‚');
        }

        const data = await response.json();

        if (data.status === 'success' && data.summary) {
            container.innerHTML = `<strong>ğŸ¤– AIè¦ç´„:</strong><div class="ai-analysis-content" style="margin-top: 5px;">${convertMarkdownToHtml(data.summary)}</div>`;
            buttonElement.style.display = 'none'; // æˆåŠŸã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’éš ã™
        } else {
            throw new Error(data.error || 'è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }

    } catch (error) {
        container.innerHTML = `<strong style="color: red;">âŒ ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}`;
        buttonElement.disabled = false;
        buttonElement.textContent = 'å†åº¦è©¦ã™';
    }
}
// --- â–²â–²â–² ã“ã“ã¾ã§é–¢æ•°å…¨ä½“ã‚’ä¿®æ­£ â–²â–²â–² ---
        
        // æ¤œç´¢ã¨çµæœã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
        window.clearSearchAndResults = function() {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('api-search-input').value = '';
            // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã‚‚ã‚¯ãƒªã‚¢
            document.getElementById('exclude-keywords-input').value = '';
            document.getElementById('search-method').value = 'semantic';
            document.getElementById('llm-expansion').checked = false;
            document.getElementById('young-researcher-filter').checked = false;
            
            // å¤§å­¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            clearUniversityFilter();
            
            // æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
            document.getElementById('api-search-results').innerHTML = `
                <div class="alert alert-info">
                    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œç ”ç©¶è€…ã‚’æ¤œç´¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                </div>
            `;
            
            // UIã‚’æ›´æ–°
            onSearchMethodChange();
            
            console.log('ğŸ—‘ï¸ æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

// å®Ÿéš›ã®APIæ¤œç´¢é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
window.performAPISearch = async function() {
    const searchInput = document.getElementById('api-search-input');
    const searchQuery = searchInput.value.trim();

    if (!searchQuery) {
        alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // --- æ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å–å¾— ---
    const searchMethod = document.getElementById('search-method').value;
    const useLLMExpansion = document.getElementById('llm-expansion').checked;
    const youngResearcherFilter = document.getElementById('young-researcher-filter').checked;
    
    // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
    const excludeKeywordsInput = document.getElementById('exclude-keywords-input').value.trim();
    
    // å±¥æ­´ä¿å­˜å‡¦ç†
    updateSearchHistory(searchQuery, SEARCH_HISTORY_KEY);
    if (excludeKeywordsInput) {
        updateSearchHistory(excludeKeywordsInput, EXCLUDE_HISTORY_KEY);
    }
    displayHistory(SEARCH_HISTORY_KEY, 'search-history-container', 'setSearchKeyword');
    displayHistory(EXCLUDE_HISTORY_KEY, 'exclude-history-container', 'setExcludeKeyword');

    // ã‚«ãƒ³ãƒã‚„ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã‚Šã€ç©ºã®è¦ç´ ã‚’é™¤å¤–ã—ã¦ãƒªã‚¹ãƒˆåŒ–
    const excludeKeywordsList = excludeKeywordsInput
        ? excludeKeywordsInput.split(/[\s,ã€]+/).filter(kw => kw.length > 0)
        : null;

    const resultsContainer = document.getElementById('api-search-results');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    resultsContainer.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            APIæ¤œç´¢ã‚’å®Ÿè¡Œä¸­ (æœ€å¤§100ä»¶)...
        </div>
    `;

    try {
        activeUniversityFilters = []; // æ¤œç´¢æ™‚ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        // APIæ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        const searchParams = {
            query: searchQuery,
            method: searchMethod,
            
            // ã‚­ãƒ¼åã‚’ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã«çµ±ä¸€
            maxResults: 100,
            excludeKeywords: excludeKeywordsList,
            useLlmExpansion: useLLMExpansion,
            useInternalEvaluation: false,
            youngResearcherFilter: youngResearcherFilter,
            universityFilter: window.selectedUniversities.length > 0 ? window.selectedUniversities : null
        };

        const apiResponse = await apiClient.searchResearchers(searchParams);
        
        fullSearchResults = apiResponse.results || [];
        currentPage = 1;

        // çµæœè¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã™
        displayAPISearchResults(apiResponse); 
        
    } catch (error) {
        console.error('APIæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <h4>ğŸ”´ APIæ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                <p><strong>ã‚¨ãƒ©ãƒ¼å†…å®¹:</strong> ${error.message}</p>
                <hr>
                <p>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        `;
    }
}

        // å¤§å­¦ãƒªã‚¹ãƒˆã‚’å–å¾—
        window.loadUniversityList = async function() {
            try {
                console.log('ğŸ« å¤§å­¦ãƒªã‚¹ãƒˆå–å¾—é–‹å§‹');
                const apiUrl = apiClient.getCurrentApiUrl();
                console.log('å–å¾—URL:', `${apiUrl}/api/universities`);
                
                const response = await fetch(`${apiUrl}/api/universities`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    signal: AbortSignal.timeout(15000) // 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                });
                
                console.log('å¤§å­¦ãƒªã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('å¤§å­¦ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', data);
                
                if (data.status === 'success' && data.universities) {
                    window.universityList = data.universities;
                    displayUniversityList();
                    console.log('âœ… å¤§å­¦ãƒªã‚¹ãƒˆå–å¾—æˆåŠŸ:', data.universities.length, 'æ ¡');
                } else if (data.status === 'fallback' && data.universities) {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¡¨ç¤º
                    window.universityList = data.universities;
                    displayUniversityList();
                    console.log('âš ï¸ å¤§å­¦ãƒªã‚¹ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰:', data.universities.length, 'æ ¡');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æƒ…å ±ã‚’è¡¨ç¤º
                    const container = document.getElementById('university-list-container');
                    container.insertAdjacentHTML('afterbegin', `
                        <div class="alert alert-warning" style="margin-bottom: 10px; font-size: 12px; padding: 8px;">
                            âš ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼ˆ${data.fallback_info?.reason || 'ä¸æ˜'}ï¼‰
                        </div>
                    `);
                } else {
                    throw new Error('æœ‰åŠ¹ãªå¤§å­¦ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            } catch (error) {
                console.error('ğŸ”´ å¤§å­¦ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                let errorMessage = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'APIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (error.name === 'TimeoutError') {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
                
                document.getElementById('university-list-container').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>ğŸ”´ å¤§å­¦ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼</strong><br>
                        ${errorMessage}<br>
                        <small>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
                        <hr style="margin: 10px 0;">
                        <button class="btn btn-secondary" onclick="loadUniversityList()" style="width: 100%; font-size: 12px;">
                            ğŸ”„ å†è©¦è¡Œ
                        </button>
                    </div>
                `;
            }
        }
        // å¤§å­¦ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º (æ¤œç´¢æ©Ÿèƒ½ãƒ»è¡¨ç¤ºä»¶æ•°åˆ¶é™ä»˜ã)
window.displayUniversityList = function() {
    const container = document.getElementById('university-list-container');
    const searchInput = document.getElementById('university-search-input');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

    if (!window.universityList || window.universityList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d;">å¤§å­¦ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    // 1. æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã§å¤§å­¦ãƒªã‚¹ãƒˆã‚’çµã‚Šè¾¼ã‚€
    const filteredUniversities = searchTerm
        ? window.universityList.filter(univ => univ.name.toLowerCase().includes(searchTerm))
        : window.universityList;

    // 2. è¡¨ç¤ºä»¶æ•°ã‚’ä¸Šä½100ä»¶ã«åˆ¶é™ã—ã¦ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¢ºä¿
    const universitiesToShow = filteredUniversities.slice(0, 100);

    let html = '';
    if (universitiesToShow.length === 0) {
        html = '<p style="text-align: center; color: #6c757d;">è©²å½“ã™ã‚‹å¤§å­¦ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
    } else {
        html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';
        universitiesToShow.forEach(univ => {
            const isChecked = window.selectedUniversities.includes(univ.name);
            const univId = `univ-${univ.name.replace(/[^\w\s]/gi, '')}`; // IDã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
            html += `
                <div class="checkbox-group" style="margin-bottom: 5px;">
                    <input type="checkbox" id="${univId}" 
                           value="${univ.name}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="toggleUniversityFilter('${univ.name.replace(/'/g, "\\'")}')"
                           style="margin-right: 8px;">
                    <label for="${univId}" style="margin-bottom: 0; cursor: pointer;">
                        ${univ.name} <span style="color: #6c757d; font-size: 12px;">(${univ.count.toLocaleString()}å)</span>
                    </label>
                </div>
            `;
        });
        html += '<\/div>';

        // æ¤œç´¢çµæœãŒ100ä»¶ã‚ˆã‚Šå¤šã„å ´åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (filteredUniversities.length > 100) {
            html += `<p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 14px;">
                ã•ã‚‰ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã‚“ã§ãã ã•ã„ (å…¨${filteredUniversities.length}ä»¶ä¸­ã€ä¸Šä½100ä»¶ã‚’è¡¨ç¤ºä¸­)
            </p>`;
        }
    }
    
    container.innerHTML = html;
};
        
        // å¤§å­¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
        window.toggleUniversityFilter = function(universityName) {
            const index = window.selectedUniversities.indexOf(universityName);
            if (index === -1) {
                window.selectedUniversities.push(universityName);
            } else {
                window.selectedUniversities.splice(index, 1);
            }
            console.log('é¸æŠã•ã‚ŒãŸå¤§å­¦:', window.selectedUniversities);
        }
        
        // å¤§å­¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        window.clearUniversityFilter = function() {
            window.selectedUniversities = [];
            displayUniversityList();
        }
        
        // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¤§å­¦ã‚’å…¨ã¦é¸æŠ
        window.selectAllUniversities = function() {
            const container = document.getElementById('university-list-container');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            
            if (checkboxes.length === 0) {
                console.log('é¸æŠå¯èƒ½ãªå¤§å­¦ãŒãƒªã‚¹ãƒˆã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            // ç¾åœ¨ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¤§å­¦åã‚’å–å¾—
            const visibleUniversities = Array.from(checkboxes).map(cb => cb.value);

            // Setã‚’ä½¿ã£ã¦é‡è¤‡ã‚’é¿ã‘ãªãŒã‚‰ã€é¸æŠä¸­ã®å¤§å­¦ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            const updatedSelectedUniversities = new Set(window.selectedUniversities);
            visibleUniversities.forEach(univ => updatedSelectedUniversities.add(univ));
            
            window.selectedUniversities = Array.from(updatedSelectedUniversities);
            
            // è¡¨ç¤ºã‚’æ›´æ–°ã—ã¦ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åæ˜ ã•ã›ã‚‹
            displayUniversityList();
            
            console.log('ã€Œå…¨ã¦é¸æŠã€ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚é¸æŠä¸­ã®å¤§å­¦æ•°:', window.selectedUniversities.length);
        }
        
        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–¢æ•°
        window.checkAPIHealth = async function() {
            try {
                const statusElement = document.getElementById('api-status');
                if (statusElement) {
                    statusElement.style.display = 'block';
                    statusElement.innerHTML = 'ğŸ”„ APIæ¥ç¶šç¢ºèªä¸­...';
                    statusElement.className = 'alert alert-info';
                }
                
                const healthCheck = await apiClient.healthCheck();
                
                if (statusElement) {
                    if (healthCheck.status === 'healthy') {
                        statusElement.innerHTML = 'ğŸŸ¢ APIæ¥ç¶šæ­£å¸¸ - ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒä¸­';
                        statusElement.className = 'alert alert-success';
                    } else {
                        statusElement.innerHTML = `ğŸ”´ APIæ¥ç¶šå¤±æ•— - ${healthCheck.message}`;
                        statusElement.className = 'alert alert-warning';
                    }
                }
                
            } catch (error) {
                console.error('API Health Check Error:', error);
                const statusElement = document.getElementById('api-status');
                if (statusElement) {
                    statusElement.innerHTML = `ğŸ”´ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ - ${error.message}`;
                    statusElement.className = 'alert alert-warning';
                }
            }
        }

        // ç ”ç©¶è€…è©³ç´°è¡¨ç¤º
        window.showResearcherDetail = function(name) {
            alert(`${name}ã®è©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»ã—ã¾ã™ï¼ˆå®Ÿè£…äºˆå®šï¼‰`);
        }
        
        // AIè©³ç´°åˆ†æã®å®Ÿè¡Œã¨è¡¨ç¤º
window.analyzeResearcherDetail = async function(researcherId, researchmapUrl, query, basicInfo) {
            if (!researchmapUrl || researchmapUrl === '#') {
                alert('ã“ã®ç ”ç©¶è€…ã®ResearchMap URLãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const modalHtml = `
                <div id="analysis-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 12px;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    ">
                        <button onclick="closeAnalysisModal()" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            border: none;
                            background: #e9ecef;
                            color: #495057;
                            padding: 8px 15px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        ">âœ•</button>
                        
                        <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ¤– AIè©³ç´°åˆ†æ</h2>
                        
                        <div id="analysis-content">
                            <div class="loading">
                                <div class="spinner"></div>
                                ResearchMapã‹ã‚‰è©³ç´°æƒ…å ±ã‚’å–å¾—ã—ã¦åˆ†æä¸­...
                            </div>
                        </div>
                        
                        <div id="analysis-actions" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <button onclick="saveAnalysisResult()" class="btn btn-primary" style="width: 100%;">
                                ğŸ’¾ ã“ã®åˆ†æçµæœã‚’ä¿å­˜
                            </button>
                            <div id="save-status" style="margin-top: 10px; text-align: center;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ç¾åœ¨ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            window.currentAnalysisData = {
                researcherId: researcherId,
                researchmap_url: researchmapUrl,
                researcher_name: basicInfo.name,
                affiliation: basicInfo.affiliation,
                query: query,
                analysis_result: null
            };
            
            try {
                const data = await apiClient.analyzeResearcher(researchmapUrl, query, basicInfo, true);
                
                if (data.status === 'success' && data.analysis) {
                    // åˆ†æçµæœã‚’è¡¨ç¤º
                    const analysis = data.analysis;
                    const contentHtml = `
                        <div>
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">
                                ${analysis.researcher_name} 
                                <small style="color: #7f8c8d;">(${analysis.affiliation})</small>
                            </h3>
                            
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                                    <div style="font-size: 24px; color: #667eea; font-weight: bold;">${analysis.scores.total || 0}/100</div>
                                    <div style="color: #495057; font-size: 14px;">ç·åˆè©•ä¾¡</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                                    <div style="font-size: 20px; color: #28a745;">${analysis.total_papers || 0}ä»¶</div>
                                    <div style="color: #495057; font-size: 14px;">è«–æ–‡ãƒ»æ¥­ç¸¾æ•°</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                                    <div style="font-size: 20px; color: #17a2b8;">${analysis.total_projects || 0}ä»¶</div>
                                    <div style="color: #495057; font-size: 14px;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                                    <div style="font-size: 20px; color: #ffc107;">${analysis.total_awards || 0}ä»¶</div>
                                    <div style="color: #495057; font-size: 14px;">å—è³æ­´</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                                    <div style="font-size: 20px; color: #2196f3;">${analysis.total_patents || 0}ä»¶</div>
                                    <div style="color: #495057; font-size: 14px;">ç‰¹è¨±</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">ğŸ“Š è©³ç´°è©•ä¾¡</h4>
                                <div style="margin-bottom: 10px;">
                                    <strong>æŠ€è¡“çš„é–¢é€£æ€§:</strong> ${analysis.scores.technical_relevance || 0}/40ç‚¹
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>å®Ÿç¸¾ãƒ»å½±éŸ¿åŠ›:</strong> ${analysis.scores.achievements || 0}/30ç‚¹
                                </div>
                                <div>
                                    <strong>å®Ÿç”¨åŒ–å¯èƒ½æ€§:</strong> ${analysis.scores.practical_applicability || 0}/30ç‚¹
                                </div>
                                <div style="margin-top: 15px; max-width: 350px; margin-left: auto; margin-right: auto;">
                                    <canvas id="modalRadarChartCanvas"></canvas>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">ğŸ“„ AIåˆ†æçµæœ</h4>
                                <div class="modal-markdown-content" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; max-height: 300px; overflow-y: auto;">
                                    ${convertMarkdownToHtml(analysis.detailed_analysis)}
                                </div>
                            </div>
                            
                            ${analysis.top_papers && analysis.top_papers.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">ğŸ“š ä¸»è¦è«–æ–‡ãƒ»æ¥­ç¸¾</h4>
                                    <ul style="list-style: none; padding: 0;">
                                        ${analysis.top_papers.map(paper => `
                                            <li style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
                                                <strong>[${paper.year}]</strong> ${paper.title_ja || paper.title_en}
                                                ${paper.journal ? `<br><small style="color: #7f8c8d;">${paper.journal}</small>` : ''}
                                            <\/li>
                                        `).join('')}
                                    <\/ul>
                                <\/div>
                            ` : ''}
                            
                            ${analysis.key_projects && analysis.key_projects.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">ğŸš€ ä¸»è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h4>
                                    <ul style="list-style: none; padding: 0;">
                                        ${analysis.key_projects.map(project => `
                                            <li style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
                                                ${project.title}
                                                <br><small style="color: #7f8c8d;">${project.period}</small>
                                            <\/li>
                                        `).join('')}
                                    <\/ul>
                                <\/div>
                            ` : ''}
                            
                            ${analysis.key_patents && analysis.key_patents.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">ğŸ’¡ ä¸»è¦ç‰¹è¨±</h4>
                                    <ul style="list-style: none; padding: 0;">
                                        ${analysis.key_patents.map(patent => `
                                            <li style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef; border-left: 4px solid #2196f3;">
                                                <strong>${patent.title}</strong>
                                                <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #666;">
                                                    <div><strong>å‡ºé¡˜ç•ªå·:</strong> ${patent.application_number || 'ä¸æ˜'}</div>
                                                    <div><strong>ç‰¹è¨±ç•ªå·:</strong> ${patent.patent_number || 'ï¼ˆå¯©æŸ»ä¸­ï¼‰'}</div>
                                                    <div><strong>å‡ºé¡˜æ—¥:</strong> ${patent.application_date || 'ä¸æ˜'}</div>
                                                    <div><strong>ç‰¹è¨±æ¨©è€…:</strong> ${patent.patent_holders || 'ä¸æ˜'}</div>
                                                </div>
                                            <\/li>
                                        `).join('')}
                                    <\/ul>
                                <\/div>
                            ` : ''}
                        <\/div>
                    `;
                    
                    document.getElementById('analysis-content').innerHTML = contentHtml;
                    
                    if (analysis.scores) {
                        const ctx = document.getElementById('modalRadarChartCanvas').getContext('2d');
                        if (ctx) {
                            const labels = ['æŠ€è¡“çš„é–¢é€£æ€§', 'å®Ÿç¸¾ãƒ»å½±éŸ¿åŠ›', 'å®Ÿç”¨åŒ–å¯èƒ½æ€§'];
                            const dataPoints = [
                                analysis.scores.technical_relevance || 0,
                                analysis.scores.achievements || 0,
                                analysis.scores.practical_applicability || 0
                            ];

                            new Chart(ctx, {
                                type: 'radar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: `${analysis.researcher_name} æ°ã®è©•ä¾¡`,
                                        data: dataPoints,
                                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        borderWidth: 2,
                                        pointBackgroundColor: 'rgba(102, 126, 234, 1)'
                                    }]
                                },
                                options: {
                                    scales: {
                                        r: {
                                            max: 40,
                                            min: 0,
                                            ticks: { stepSize: 10 }
                                        }
                                    }
                                }
                            });
                        }
                    }
                    
                    // åˆ†æçµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                    window.currentAnalysisData.analysis_result = analysis;
                    window.currentAnalysisData.relevance_score = analysis.scores ? analysis.scores.total : null;
                    
                    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('analysis-actions').style.display = 'block';

                } else {
                    throw new Error(data.error || 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('ResearchMapåˆ†æã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('analysis-content').innerHTML = `
                    <div class="alert alert-warning">
                        <h4>ğŸ”´ åˆ†æã‚¨ãƒ©ãƒ¼</h4>
                        <p>${error.message}</p>
                        <p>ã‚¨ãƒ©ãƒ¼ãŒç¶™ç¶šã™ã‚‹å ´åˆã¯ã€ResearchMapã®APIãŒåˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                    </div>
                `;
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeAnalysisModal = function() {
            const modal = document.getElementById('analysis-modal');
            if (modal) {
                modal.remove();
            }
        }
        
// åˆ†æçµæœã‚’ä¿å­˜
window.saveAnalysisResult = async function() {
    if (!window.currentAnalysisData || !window.currentAnalysisData.analysis_result) {
        alert('ä¿å­˜ã™ã‚‹åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
    console.log("ã“ã‚Œã‹ã‚‰ä¿å­˜ã™ã‚‹åˆ†æãƒ‡ãƒ¼ã‚¿:", JSON.stringify(window.currentAnalysisData, null, 2));

    const statusEl = document.getElementById('save-status');

    try {
        const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
        
        const newAnalysisId = `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        
        savedAnalyses.push({
            ...window.currentAnalysisData,
            id: newAnalysisId,
            analysis_id: newAnalysisId, 
            created_at: new Date().toISOString() // ã‚­ãƒ¼ã‚’ 'created_at' ã«ä¿®æ­£
        });
        localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
        
        statusEl.innerHTML = '<span style="color: #4caf50;">âœ… ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã—ã¾ã—ãŸ</span>';
        
        const researcherId = window.currentAnalysisData.researcherId;
        if (researcherId) {
            const originalButton = document.querySelector(`#card-${researcherId} [data-action="analyze"]`);
            
            if (originalButton) {
                const newButtonHtml = `<a href="researcher-analysis.html?id=${newAnalysisId}" class="btn btn-secondary" style="background-color: #d4edda; border-color: #155724; color: #155724;">ğŸ“‚ ä¿å­˜ã—ãŸåˆ†æçµæœ</a>`;
                originalButton.outerHTML = newButtonHtml;
            }
        }
        
        if (typeof updateSavedAnalysisCount === 'function') {
            updateSavedAnalysisCount();
        }
        
        setTimeout(() => {
            closeAnalysisModal();
        }, 2000);

    } catch (error) {
        statusEl.innerHTML = '<span style="color: #dc3545;">âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    }
}

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentResearcher = null;
        let selectedProjectId = null;

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openProjectSelectModal = function(researcher) {
            currentResearcher = researcher;
            selectedProjectId = null;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('project-select-modal').style.display = 'flex';
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
            loadProjectList();
            
            // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('add-to-project-btn').disabled = true;
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeProjectSelectModal = function() {
            document.getElementById('project-select-modal').style.display = 'none';
            currentResearcher = null;
            selectedProjectId = null;
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        window.loadProjectList = function() {
            const tempProjects = JSON.parse(localStorage.getItem('tempProjects') || '[]');
            const container = document.getElementById('project-list-container');
            
            if (tempProjects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                        <p>ä»®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        <p>ä¸Šè¨˜ã‹ã‚‰æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tempProjects.forEach(project => {
                const researcherCount = (project.selected_researchers || []).length;
                const statusText = project.status === 'matching_requested' ? 'ä¾é ¼é€ä¿¡æ¸ˆã¿' : 'ä½œæˆä¸­';
                
                html += `
                    <div class="project-select-item" onclick="selectProject('${project.id}')" style="
                        border: 2px solid #e9ecef;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        <div class="project-name" style="
                            font-size: 18px;
                            font-weight: 600;
                            color: #2c3e50;
                            margin-bottom: 8px;
                        ">${project.name}<\/div>
                        <div class="project-meta" style="
                            font-size: 14px;
                            color: #7f8c8d;
                            margin-bottom: 5px;
                        ">
                            ä½œæˆæ—¥: ${new Date(project.created_at).toLocaleDateString('ja-JP')} | 
                            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusText} | 
                            ç ”ç©¶è€…: ${researcherCount}å
                        <\/div>
                        <div class="project-description" style="
                            color: #495057;
                            line-height: 1.5;
                        ">
                            ${project.description.substring(0, 100)}${project.description.length > 100 ? '...' : ''}
                        <\/div>
                    <\/div>
                `;
            });
            
            container.innerHTML = html;
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
        window.selectProject = function(projectId) {
            // å‰ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.project-select-item').forEach(item => {
                item.style.borderColor = '#e9ecef';
                item.style.background = 'white';
            });
            
            // æ–°ã—ã„é¸æŠã‚’è¨­å®š
            event.target.closest('.project-select-item').style.borderColor = '#667eea';
            event.target.closest('.project-select-item').style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)';
            selectedProjectId = projectId;
            
            // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('add-to-project-btn').disabled = false;
        };

        // é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç ”ç©¶è€…ã‚’è¿½åŠ 
        window.addResearcherToSelectedProject = function() {
            if (!currentResearcher || !selectedProjectId) {
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                const tempProjects = JSON.parse(localStorage.getItem('tempProjects') || '[]');
                const project = tempProjects.find(p => p.id === selectedProjectId);
                
                if (!project) {
                    alert('é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ç ”ç©¶è€…æƒ…å ±ã‚’æ•´ç†
                const researcherData = {
                    name: currentResearcher.name,
                    affiliation: currentResearcher.affiliation,
                    url: currentResearcher.url || '',
                    query: currentResearcher.query || '',
                    added_at: new Date().toISOString(),
                    analysis_score: null, // AIåˆ†æãŒå®Ÿè¡Œã•ã‚ŒãŸã‚‰æ›´æ–°ã•ã‚Œã‚‹
                    has_analysis: false
                };
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (!project.selected_researchers) {
                    project.selected_researchers = [];
                }
                
                const exists = project.selected_researchers.some(r => r.name === researcherData.name);
                if (exists) {
                    alert('ã“ã®ç ”ç©¶è€…ã¯æ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™');
                    return;
                }
                
                // ç ”ç©¶è€…ã‚’è¿½åŠ 
                project.selected_researchers.push(researcherData);
                project.updated_at = new Date().toISOString();
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('tempProjects', JSON.stringify(tempProjects));
                
                // ç ”ç©¶è€…åˆ†æãƒ‡ãƒ¼ã‚¿ã«ã‚‚ä¿å­˜
                saveToResearcherAnalysis(researcherData);
                
                alert(`ã€Œ${researcherData.name}ã€ã‚’ã€Œ${project.name}ã€ã«è¿½åŠ ã—ã¾ã—ãŸ`);
                // UIã‚’å³æ™‚æ›´æ–°ã™ã‚‹
                const researcherId = currentResearcher.id;
                if (researcherId) {
                    const card = document.getElementById(`card-${researcherId}`);
                    if (card) {
                        // æ—¢å­˜ã®ã€Œè¿½åŠ æ¸ˆã€ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°ä¸€æ—¦å‰Šé™¤ï¼ˆè¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ æ™‚ã®é‡è¤‡è¡¨ç¤ºã‚’é˜²ãï¼‰
                        const existingLabel = card.querySelector('.project-added-label');
                        if (existingLabel) {
                            existingLabel.remove();
                        }

                        // ãƒœã‚¿ãƒ³ãŒç½®ã‹ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’æ¢ã™
                        const buttonGroup = card.querySelector('.button-group');
                        if (buttonGroup) {
                            // æ–°ã—ã„ã€Œè¿½åŠ æ¸ˆã€ãƒ©ãƒ™ãƒ«ã®HTMLã‚’ç”Ÿæˆ
                            const newLabelHtml = `
                                <div class="project-added-label" style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600; font-size: 14px; margin-top: 15px;">
                                    âœ…ã€Œ${project.name}ã€ã«ã‚‚è¿½åŠ æ¸ˆã§ã™
                                <\/div>
                            `;
                            // ãƒœã‚¿ãƒ³ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å‰ã«æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’æŒ¿å…¥
                            buttonGroup.insertAdjacentHTML('beforebegin', newLabelHtml);
                        }
                    }
                }
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeProjectSelectModal();
                
            } catch (error) {
                console.error('ç ”ç©¶è€…è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç ”ç©¶è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        };

        // ç ”ç©¶è€…åˆ†æãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
        window.saveToResearcherAnalysis = function(researcherData) {
            try {
                const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
                
                // æ—¢ã«ä¿å­˜æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
                const exists = savedAnalyses.some(analysis => 
                    analysis.researcher_name === researcherData.name && 
                    analysis.affiliation === researcherData.affiliation
                );
                
                if (!exists) {
                    const analysisData = {
                        id: `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                        researcher_name: researcherData.name,
                        affiliation: researcherData.affiliation,
                        researchmap_url: researcherData.url,
                        query: researcherData.query,
                        saved_at: new Date().toISOString(),
                        analysis_result: null, // AIåˆ†æçµæœã¯ã¾ã ãªã„
                        relevance_score: null,
                        has_detailed_analysis: false
                    };
                    
                    savedAnalyses.push(analysisData);
                    localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
                    
                    console.log('âœ… ç ”ç©¶è€…åˆ†æãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜:', researcherData.name);
                }
            } catch (error) {
                console.error('ç ”ç©¶è€…åˆ†æãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        window.createNewProjectFromModal = function() {
            // ç ”ç©¶è€…æƒ…å ±ã‚’ä¸€æ™‚ä¿å­˜
            if (currentResearcher) {
                sessionStorage.setItem('pendingResearcher', JSON.stringify(currentResearcher));
            }
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆç”»é¢ã«é·ç§»
            window.location.href = 'project-create.html';
        };

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå€™è£œè¿½åŠ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨ç‰ˆï¼‰
    window.addToProjectCandidates = function(researcherId, name, affiliation = '', url = '') {
    const query = document.getElementById('api-search-input').value.trim();

    const researcher = {
        id: researcherId, // â˜…researcherIdã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å«ã‚ã‚‹
        name: name,
        affiliation: affiliation,
        url: url,
        query: query
    };

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    openProjectSelectModal(researcher);
}

        window.showLogoutMessage = function() {
            alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç ”ç©¶è€…æ¤œç´¢ãƒšãƒ¼ã‚¸ã§APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            checkAPIHealth();
            
            // å¤§å­¦ãƒªã‚¹ãƒˆã‚’å–å¾—
            loadUniversityList();
            
            // æ¤œç´¢æ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
            const searchMethodSelect = document.getElementById('search-method');
            if (searchMethodSelect) {
                searchMethodSelect.addEventListener('change', onSearchMethodChange);
                // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                onSearchMethodChange();
            }
            
            // ä¿å­˜æ¸ˆã¿åˆ†æã®æ•°ã‚’è¡¨ç¤º
            updateSavedAnalysisCount();
            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸå±¥æ­´ã‚’è¡¨ç¤º
            displayHistory(SEARCH_HISTORY_KEY, 'search-history-container', 'setSearchKeyword');
            displayHistory(EXCLUDE_HISTORY_KEY, 'exclude-history-container', 'setExcludeKeyword');
        });
        
        // ä¿å­˜æ¸ˆã¿åˆ†æã®æ•°ã‚’æ›´æ–°
        function updateSavedAnalysisCount() {
            try {
                const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
                const count = savedAnalyses.length;
                
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã®ã€Œä¿å­˜æ¸ˆã¿åˆ†æçµæœã‚’ç®¡ç†ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’æ›´æ–°
                const analysisLink = document.querySelector('a[href="researcher-analysis.html"].btn');
                const countBadge = `<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">${count}ä»¶</span>`;
                
                if (analysisLink) {
                   if (count > 0) {
                       analysisLink.innerHTML = `ğŸ“‚ ä¿å­˜æ¸ˆã¿åˆ†æçµæœã‚’ç®¡ç† ${countBadge}`;
                   } else {
                       // ä»¶æ•°ãŒ0ã®å ´åˆã¯ãƒãƒƒã‚¸ã‚’è¡¨ç¤ºã—ãªã„
                       analysisLink.innerHTML = `ğŸ“‚ ä¿å­˜æ¸ˆã¿åˆ†æçµæœã‚’ç®¡ç†`;
                   }
                }
            } catch (error) {
                console.error('ä¿å­˜æ¸ˆã¿åˆ†ææ•°ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
// æ¤œç´¢å±¥æ­´é–¢é€£ã®é–¢æ•°ç¾¤

/**
 * æ¤œç´¢å±¥æ­´ã‚’localStorageã«ä¿å­˜ãƒ»æ›´æ–°ã™ã‚‹
 * @param {string} keyword ä¿å­˜ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
 * @param {string} storageKey localStorageã®ã‚­ãƒ¼
 */
function updateSearchHistory(keyword, storageKey) {
    if (!keyword) return;

    let history = JSON.parse(localStorage.getItem(storageKey) || '[]');
    
    // æ—¢å­˜ã®å±¥æ­´ã‹ã‚‰åŒã˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã€é‡è¤‡ã‚’é˜²ã
    history = history.filter(item => item !== keyword);
    
    // å…ˆé ­ã«æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    history.unshift(keyword);
    
    // å±¥æ­´ãŒæœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ï¼ˆæœ«å°¾ï¼‰ã‚’å‰Šé™¤
    if (history.length > MAX_HISTORY_COUNT) {
        history.pop();
    }
    
    localStorage.setItem(storageKey, JSON.stringify(history));
}

/**
 * ä¿å­˜ã•ã‚ŒãŸå±¥æ­´ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
 * @param {string} storageKey localStorageã®ã‚­ãƒ¼
 * @param {string} containerId è¡¨ç¤ºå…ˆã‚³ãƒ³ãƒ†ãƒŠã®ID
 * @param {string} onClickFunction ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å‘¼ã³å‡ºã™é–¢æ•°å
 */
function displayHistory(storageKey, containerId, onClickFunction) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const history = JSON.parse(localStorage.getItem(storageKey) || '[]');
    container.innerHTML = history.map(item => {
        const escapedItem = item.replace(/'/g, "\\'");
        // ã‚¿ã‚°æœ¬ä½“ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å«ã‚€HTMLã‚’ç”Ÿæˆ
        return `
            <span class="history-tag">
                <span class="history-keyword" onclick="${onClickFunction}('${escapedItem}')">${item}</span>
                <button class="delete-history-btn" onclick="deleteHistoryItem('${escapedItem}', '${storageKey}', event)" title="ã“ã®å±¥æ­´ã‚’å‰Šé™¤">&times;<\/button>
            <\/span>
        `;
    }).join('');
}

/**
 * å±¥æ­´é …ç›®ã‚’å€‹åˆ¥ã«å‰Šé™¤ã™ã‚‹
 * @param {string} keyword å‰Šé™¤ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
 * @param {string} storageKey localStorageã®ã‚­ãƒ¼
 * @param {Event} event ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
 */
window.deleteHistoryItem = function(keyword, storageKey, event) {
    // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
    event.stopPropagation();

    let history = JSON.parse(localStorage.getItem(storageKey) || '[]');
    
    // è©²å½“ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å±¥æ­´ã‹ã‚‰é™¤å¤–
    history = history.filter(item => item !== keyword);
    
    // localStorageã‚’æ›´æ–°
    localStorage.setItem(storageKey, JSON.stringify(history));
    
    // å±¥æ­´è¡¨ç¤ºã‚’å†æç”»
    if (storageKey === SEARCH_HISTORY_KEY) {
        displayHistory(SEARCH_HISTORY_KEY, 'search-history-container', 'setSearchKeyword');
    } else if (storageKey === EXCLUDE_HISTORY_KEY) {
        displayHistory(EXCLUDE_HISTORY_KEY, 'exclude-history-container', 'setExcludeKeyword');
    }
}

/**
 * å±¥æ­´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆã™ã‚‹
 * @param {string} keyword ã‚»ãƒƒãƒˆã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
 */
window.setSearchKeyword = function(keyword) {
    document.getElementById('api-search-input').value = keyword;
}

/**
 * å±¥æ­´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆã™ã‚‹
 * @param {string} keyword ã‚»ãƒƒãƒˆã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
 */
window.setExcludeKeyword = function(keyword) {
    document.getElementById('exclude-keywords-input').value = keyword;
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å¤§å­¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢é€£ã®é–¢æ•°

/**
 * å¤§å­¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é¸æŠçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã«å‘¼ã°ã‚Œã‚‹ï¼‰
 * @param {string} universityName é¸æŠã•ã‚ŒãŸå¤§å­¦å
 * @param {Event} event ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
 */
window.toggleActiveUniversityFilter = function(universityName, event) {
    const isCtrlOrCmd = event.ctrlKey || event.metaKey; // Ctrl(Win) or Cmd(Mac)

    if (isCtrlOrCmd) {
        // Ctrl/Cmdã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼šé¸æŠçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
        const index = activeUniversityFilters.indexOf(universityName);
        if (index > -1) {
            activeUniversityFilters.splice(index, 1); // æ—¢ã«ã‚ã‚Œã°å‰Šé™¤
        } else {
            activeUniversityFilters.push(universityName); // ãªã‘ã‚Œã°è¿½åŠ 
        }
    } else {
        // å˜ç‹¬ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆï¼šãã®å¤§å­¦ã®ã¿ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        // ã‚‚ã—æ—¢ã«ãã®å¤§å­¦ã ã‘ãŒé¸æŠã•ã‚Œã¦ã„ãŸå ´åˆã¯ã€é¸æŠã‚’å…¨è§£é™¤ã™ã‚‹
        if (activeUniversityFilters.length === 1 && activeUniversityFilters[0] === universityName) {
            activeUniversityFilters = [];
        } else {
            activeUniversityFilters = [universityName];
        }
    }
    currentPage = 1; // çµã‚Šè¾¼ã‚“ã ã‚‰ãƒšãƒ¼ã‚¸ã‚’1ã«æˆ»ã™
    // è¡¨ç¤ºã‚’æ›´æ–°
    displayAPISearchResults({ query: document.getElementById('api-search-input').value.trim() });
};

/**
 * å¤§å­¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å…¨ä»¶è¡¨ç¤ºã«æˆ»ã™
 */
window.resetActiveUniversityFilter = function() {
    activeUniversityFilters = [];
    currentPage = 1; // ãƒšãƒ¼ã‚¸ã‚’1ã«æˆ»ã™
    // è¡¨ç¤ºã‚’æ›´æ–°
    displayAPISearchResults({ query: document.getElementById('api-search-input').value.trim() });
};
    </script>
</body>
</html>