<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶è€…è©³ç´°åˆ†æ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.7/build/d3.layout.cloud.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            display: flex; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ¨ªä¸¦ã³ã« */
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .info-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .info-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .info-item {
            margin-bottom: 15px;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px 0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #0c5460;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #155724;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #856404;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: #721c24;
            color: #721c24;
        }
        
        #analysis-result-container {
            display: none;
        }
        
        #analysis-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        #analysis-content h3 {
            color: #2c3e50;
            margin: 20px 0 15px 0;
            font-size: 18px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        #analysis-content ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        #analysis-content p {
            margin-bottom: 15px;
        }
        
        .analysis-actions {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .saved-analyses-section {
            margin-top: 40px;
        }
        
        .saved-analyses-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .saved-analysis-item {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .saved-analysis-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .saved-analysis-item p {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 15px;
        }

        .analysis-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            min-width: 250px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            position: relative; /* For positioning the close button */
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px 40px; /* Increased padding */
            border: 1px solid #888;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #aaa;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }
        
        .close:hover,
        .close:focus {
            color: black;
        }
        
        .project-select-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .project-select-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .project-select-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }
        
        .project-name {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .project-meta {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .project-description {
            color: #495057;
            line-height: 1.5;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }
        
        .markdown-content h1 { font-size: 24px; }
        .markdown-content h2 { font-size: 20px; }
        .markdown-content h3 { font-size: 18px; }
        .markdown-content h4 { font-size: 16px; }
        .markdown-content h5 { font-size: 14px; }
        .markdown-content h6 { font-size: 12px; }
        
        .markdown-content p {
            margin: 10px 0;
            line-height: 1.7;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        .markdown-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .markdown-content code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .markdown-content em {
            font-style: italic;
            color: #495057;
        }
        
        .markdown-content hr {
            margin: 25px 0;
            border: none;
            border-top: 2px solid #e9ecef;
        }
        
        .markdown-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-bottom-color 0.3s ease;
        }
        
        .markdown-content a:hover {
            border-bottom-color: #667eea;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .menu-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.3);
        }
        
        .map-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            gap: 20px;
            flex-wrap: wrap;
        }

        .map-search {
            display: flex;
            gap: 8px;
        }

        #keyword-search-input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            min-width: 250px;
        }

        .map-legend {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>ğŸ¤ ãƒªã‚µãƒ¼ãƒãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h1>
        <hr style="border-color: rgba(255,255,255,0.3); margin: 20px 0;">
        
        <a href="index.html" class="menu-item">
            ğŸ” ç ”ç©¶è€…æ¤œç´¢
        </a>
        <a href="researcher-analysis.html" class="menu-item">
            ğŸ“‚ ä¿å­˜æ¸ˆã¿åˆ†æ
        </a>
        <a href="project.html" class="menu-item">
            ğŸ“Š ãƒã‚¤ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
        </a>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>ğŸ”¬ ä¿å­˜æ¸ˆã¿åˆ†æ</h1>
                <p>ä¿å­˜ã—ãŸåˆ†æçµæœã®é–²è¦§ã€å†åˆ†æã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®è¿½åŠ ãŒã§ãã¾ã™</p>
            </div>
            
            <div class="info-section">
                <h2>åˆ†æè¨­å®š</h2>
                <div class="form-group">
                    <label>ç ”ç©¶è€…å</label>
                    <input type="text" id="researcher-name" class="form-control" placeholder="ä¾‹: å±±ç”° å¤ªéƒ" value="">
                </div>
                
                <div class="form-group">
                    <label>ResearchMap URL</label>
                    <input type="text" id="researchmap-url" class="form-control" placeholder="https://researchmap.jp/xxxxx" value="">
                </div>
                
                <div class="form-group">
                    <label>åˆ†æã‚¯ã‚¨ãƒªï¼ˆã©ã‚“ãªè¦³ç‚¹ã§åˆ†æã™ã‚‹ã‹ï¼‰</label>
                    <input type="text" id="analysis-query" class="form-control" placeholder="ä¾‹: AIææ–™æ¢ç´¢ã€æ©Ÿæ¢°å­¦ç¿’ã€ãƒŠãƒãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼" value="">
                </div>
                
                <button class="btn btn-primary" onclick="startAnalysis()">
                    ğŸ¤– AIåˆ†æã‚’é–‹å§‹
                </button>
            </div>
            
            <div id="analysis-result-container">
                <div class="info-section">
                    <h2>åˆ†æçµæœ</h2>
                    <div id="analysis-content">
                        </div>
                </div>
                
                <div class="analysis-actions">
                    <button id="save-analysis-btn" class="btn btn-primary" onclick="saveCurrentAnalysis()">
                        ğŸ’¾ ã“ã®åˆ†æçµæœã‚’ä¿å­˜
                    </button>
                    <button id="add-current-to-project-btn" class="btn btn-primary" onclick="addCurrentAnalysisToProject()" style="display: none;">
                        â• ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
                    </button>
                    <button id="show-keyword-map-btn" class="btn btn-secondary" onclick="showKeywordAnalysis()" style="display: none;">
                        ğŸ“Š ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
                    </button>
                    <span id="save-status"></span>
                </div>
            </div>
            
            <div class="saved-analyses-section">
                <h3>ğŸ“‚ ä¿å­˜æ¸ˆã¿ã®åˆ†æçµæœ</h3>
                <div id="saved-analyses-list">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
        
        <div id="analysisModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>åˆ†æçµæœè©³ç´°</h2>
                <div id="modal-analysis-content"></div>
            </div>
        </div>
    
        <div id="project-select-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProjectSelectModal()">&times;</span>
                <h2>ç ”ç©¶è€…ã‚’è¿½åŠ ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</h2>
                
                <div style="
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    text-align: center;
                    padding: 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-bottom: 20px;
                    transition: all 0.3s ease;
                " onclick="createNewProjectFromModal()">
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                        â• æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        æ–°ã—ã„ä»®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ç ”ç©¶è€…ã‚’è¿½åŠ 
                    </div>
                </div>
                
                <div id="project-list-container">
                    </div>
                
                <div style="
                    margin-top: 25px;
                    padding-top: 20px;
                    border-top: 2px solid #e9ecef;
                    display: flex;
                    gap: 15px;
                    justify-content: flex-end;
                ">
                    <button class="btn btn-secondary" onclick="closeProjectSelectModal()">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button id="add-to-project-btn" class="btn btn-primary" onclick="addResearcherToSelectedProject()" disabled>
                        é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="keyword-map-modal" class="modal">
        <div class="modal-content" style="max-width: 1400px; width: 95%; height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ</h2>
                <span class="close" onclick="closeKeywordMapModal()">&times;</span>
            </div>
            <p>ç ”ç©¶è€…ã®ç ”ç©¶é ˜åŸŸã‚„å‚¾å‘ã‚’åˆ†ã‹ã‚Šã‚„ã™ãå¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
            
            <div style="display: flex; flex: 1; gap: 20px; margin-top: 20px; overflow: hidden;">
                <!-- Left Column -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0;">
                    <!-- Top-Left: Word Cloud -->
                    <div style="flex: 1; display: flex; flex-direction: column; background: #f8f9fa; border-radius: 8px; padding: 15px; min-height: 0;">
                        <h3>ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰</h3>
                        <div id="word-cloud-container" style="flex-grow: 1; width: 100%; height: 100%;"></div>
                    </div>
                    <!-- Bottom-Left: Academic Fields -->
                    <div style="flex: 1; display: flex; flex-direction: column; background: #f8f9fa; border-radius: 8px; padding: 15px; overflow-y: auto; min-height: 0;">
                        <h3>ä¸»è¦ãªå­¦å•é ˜åŸŸ</h3>
                        <div id="academic-fields-container"></div>
                    </div>
                </div>
                <!-- Right Column -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0;">
                    <!-- Top-Right: Research Trends -->
                    <div style="flex: 1; display: flex; flex-direction: column; background: #f8f9fa; border-radius: 8px; padding: 15px; min-height: 0;">
                        <h3>ç ”ç©¶ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
                        <div id="trend-chart-container" style="flex-grow: 1; width: 100%; min-height: 200px;"></div>
                    </div>
                    <!-- Bottom-Right: AI Comment -->
                    <div style="flex: 1; display: flex; flex-direction: column; background: #f8f9fa; border-radius: 8px; padding: 15px; overflow-y: auto; min-height: 0;">
                        <h3>AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                        <div id="keyword-llm-comment" style="flex-grow: 1; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="api-client.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentAnalysisData = null;
        let currentResearcher = null;
        let selectedProjectId = null;
        let isWordCloudScriptLoaded = false;
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            migrateSavedAnalyses();
            activateCurrentMenuItem();
            initializeFromUrlParams();
            loadSavedAnalyses();
            setupModalCloseButtons();
        });

        // ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã«IDã‚„æ—¥ä»˜ãŒãªã„å ´åˆã«ä»˜ä¸ã™ã‚‹
        function migrateSavedAnalyses() {
            let savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            let needsUpdate = false;
            savedAnalyses.forEach(analysis => {
                if (!analysis.analysis_id) {
                    analysis.analysis_id = `analysis_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                    needsUpdate = true;
                }
                // created_atãŒæ¬ æã€ã¾ãŸã¯ç„¡åŠ¹ãªæ—¥ä»˜ã®å ´åˆã«ä¿®å¾©
                if (!analysis.created_at || isNaN(new Date(analysis.created_at).getTime())) {
                    analysis.created_at = new Date().toISOString();
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
            }
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ç¾åœ¨åœ°ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        function activateCurrentMenuItem() {
            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar .menu-item').forEach(item => {
                item.classList.toggle('active', currentPage.includes(item.getAttribute('href')));
            });
        }

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸå€¤ã‚’è¨­å®šãƒ»è¡¨ç¤º
        function initializeFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const analysisId = urlParams.get('id');
            
            document.getElementById('researcher-name').value = urlParams.get('name') || '';
            document.getElementById('researchmap-url').value = urlParams.get('url') || '';
            document.getElementById('analysis-query').value = urlParams.get('query') || '';
            
            if (analysisId) {
                viewSavedAnalysisFromUrl(analysisId);
            }
        }

        // å…¨ã¦ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        function setupModalCloseButtons() {
            document.querySelectorAll('.modal').forEach(modal => {
                const closeBtn = modal.querySelector('.close');
                if (closeBtn) {
                    closeBtn.onclick = () => modal.style.display = 'none';
                }
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }

        // URLã‹ã‚‰ç‰¹å®šã®ä¿å­˜æ¸ˆã¿åˆ†æã‚’è¡¨ç¤º
        async function viewSavedAnalysisFromUrl(analysisId) {
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            const analysis = savedAnalyses.find(a => a.analysis_id === analysisId);
            if (!analysis) {
                alert('æŒ‡å®šã•ã‚ŒãŸåˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // å¸¸ã«currentAnalysisDataã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¨­å®š
            currentAnalysisData = { ...analysis }; 
            document.getElementById('researcher-name').value = analysis.researcher_name || '';
            document.getElementById('researchmap-url').value = analysis.researchmap_url || '';
            document.getElementById('analysis-query').value = analysis.query || '';

            const saveBtn = document.getElementById('save-analysis-btn');

            if (analysis.analysis_result) {
                // åˆ†ææ¸ˆã¿ã®å ´åˆ
                document.getElementById('analysis-result-container').style.display = 'block';
                displayAnalysisResult(analysis.analysis_result);
                document.getElementById('add-current-to-project-btn').style.display = 'inline-block';
                saveBtn.textContent = 'âœ… ä¿å­˜æ¸ˆã¿';
                saveBtn.disabled = true;
            } else {
                // åˆ†ææœªå®Ÿæ–½ã®å ´åˆ
                document.getElementById('analysis-result-container').style.display = 'none';
                document.getElementById('analysis-content').innerHTML = '';
                document.getElementById('add-current-to-project-btn').style.display = 'none';
                saveBtn.textContent = 'ğŸ’¾ ã“ã®åˆ†æçµæœã‚’ä¿å­˜';
                saveBtn.disabled = true; // åˆ†æãŒå®Œäº†ã™ã‚‹ã¾ã§ä¿å­˜ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹
            }
        }

        // AIåˆ†æã‚’é–‹å§‹
        async function startAnalysis() {
            const researcherName = document.getElementById('researcher-name').value.trim();
            const researchmapUrl = document.getElementById('researchmap-url').value.trim();
            const query = document.getElementById('analysis-query').value.trim();
            
            if (!researcherName || !researchmapUrl || !query) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultContainer = document.getElementById('analysis-result-container');
            const contentDiv = document.getElementById('analysis-content');
            resultContainer.style.display = 'block';
            contentDiv.innerHTML = `<div class="loading"><div class="spinner"></div>AIåˆ†æã‚’å®Ÿè¡Œä¸­...</div>`;
            document.getElementById('save-analysis-btn').disabled = true;
            
            try {
                const result = await apiClient.analyzeResearcher(researchmapUrl, query, { name_ja: researcherName }, true);
                console.log('Analysis result:', result); // Add this line for debugging
                if (result.status !== 'success' || !result.analysis) {
                    throw new Error(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                }
                
                displayAnalysisResult(result.analysis);
                
                currentAnalysisData = {
                    ...currentAnalysisData, // æ—¢å­˜ã®IDã‚„created_atã‚’ä¿æŒ
                    researchmap_url: researchmapUrl,
                    researcher_name: researcherName,
                    query: query,
                    analysis_result: result.analysis,
                    affiliation: result.analysis.affiliation || 'ä¸æ˜',
                    relevance_score: result.analysis.scores?.total || null,
                    updated_at: new Date().toISOString() // æ›´æ–°æ—¥æ™‚ã‚’ã‚»ãƒƒãƒˆ
                };

                // æ–°è¦åˆ†æã®å ´åˆã€IDã¨ä½œæˆæ—¥æ™‚ã‚’ã‚»ãƒƒãƒˆ
                if (!currentAnalysisData.analysis_id) {
                    currentAnalysisData.analysis_id = `analysis_${Date.now()}`;
                }
                if (!currentAnalysisData.created_at) {
                    currentAnalysisData.created_at = new Date().toISOString();
                }

                document.getElementById('save-analysis-btn').disabled = false;
                document.getElementById('add-current-to-project-btn').style.display = 'inline-block';
            } catch (error) {
                console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                contentDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</div>`;
            }
        }

        // åˆ†æçµæœã®HTMLã‚’ç”Ÿæˆ
        function generateAnalysisHtml(analysis, canvasId) {
            if (!analysis) return '<div class="alert alert-info">åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';

            const {
                researcher_name, affiliation, scores, total_papers, total_projects,
                total_awards, total_patents, detailed_analysis,
                top_papers = [], key_projects = [], key_patents = []
            } = analysis;

            let html = '';
            if (researcher_name) html += `<h3>ç ”ç©¶è€…æƒ…å ±</h3><div class="info-item"><span class="info-label">æ°å:</span> ${researcher_name}</div><div class="info-item"><span class="info-label">æ‰€å±:</span> ${affiliation || 'N/A'}</div>`;
            if (scores) html += `<h3>è©•ä¾¡ã‚¹ã‚³ã‚¢</h3><div class="info-item"><span class="info-label">ç·åˆè©•ä¾¡:</span> ${scores.total || 0}/100</div><div class="info-item"><span class="info-label">æŠ€è¡“çš„é–¢é€£æ€§:</span> ${scores.technical_relevance || 0}/40</div><div class="info-item"><span class="info-label">å®Ÿç¸¾ãƒ»å½±éŸ¿åŠ›:</span> ${scores.achievements || 0}/30</div><div class="info-item"><span class="info-label">å®Ÿç”¨åŒ–å¯èƒ½æ€§:</span> ${scores.practical_applicability || 0}/30</div><div style="margin-top: 20px; max-width: 450px; margin-left: auto; margin-right: auto;"><canvas id="${canvasId}"></canvas></div>`;
            if (total_papers !== undefined) html += `<h3>ç ”ç©¶å®Ÿç¸¾</h3><div class="info-item"><span class="info-label">è«–æ–‡æ•°:</span> ${total_papers || 0}ä»¶</div><div class="info-item"><span class="info-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°:</span> ${total_projects || 0}ä»¶</div><div class="info-item"><span class="info-label">å—è³æ­´:</span> ${total_awards || 0}ä»¶</div><div class="info-item"><span class="info-label">ç‰¹è¨±:</span> ${total_patents || 0}ä»¶</div>`;
            if (detailed_analysis) html += `<h3>AIåˆ†æçµæœ</h3><div class="markdown-content" style="line-height: 1.8; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">${convertMarkdownToHtml(detailed_analysis)}</div>`;
            if (top_papers.length > 0) html += `<h3>ä¸»è¦è«–æ–‡</h3><ul style="margin: 10px 0; padding-left: 25px;">${top_papers.map(p => `<li style="margin-bottom: 8px;"><strong>[${p.year}]</strong> ${p.title_ja || p.title_en}${p.journal ? ` - ${p.journal}` : ''}</li>`).join('')}</ul>`;
            if (key_projects.length > 0) html += `<h3>ä¸»è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3><ul style="margin: 10px 0; padding-left: 25px;">${key_projects.map(p => `<li style="margin-bottom: 8px;">${p.title} (${p.period})</li>`).join('')}</ul>`;
            if (key_patents.length > 0) html += `<h3>ä¸»è¦ç‰¹è¨±</h3><ul style="margin: 10px 0; padding-left: 25px;">${key_patents.map(p => `<li style="margin-bottom: 12px;"><strong>${p.title}</strong><br>å‡ºé¡˜ç•ªå·: ${p.application_number || 'ä¸æ˜'} / ç‰¹è¨±ç•ªå·: ${p.patent_number || 'ï¼ˆå¯©æŸ»ä¸­ï¼‰'}</li>`).join('')}</ul>`;
            
            return html;
        }

        // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
        function drawRadarChart(canvasId, scores, researcherName) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !scores) return;
            const ctx = canvas.getContext('2d');

            if (canvas.chart) canvas.chart.destroy();

            canvas.chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['æŠ€è¡“çš„é–¢é€£æ€§', 'å®Ÿç¸¾ãƒ»å½±éŸ¿åŠ›', 'å®Ÿç”¨åŒ–å¯èƒ½æ€§'],
                    datasets: [{
                        label: `${researcherName} æ°ã®è©•ä¾¡`,
                        data: [scores.technical_relevance || 0, scores.achievements || 0, scores.practical_applicability || 0],
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { r: { max: 40, min: 0, ticks: { stepSize: 10 }, pointLabels: { font: { size: 14 } } } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // åˆ†æçµæœã‚’ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
        function displayAnalysisResult(analysis) {
            const contentDiv = document.getElementById('analysis-content');
            contentDiv.innerHTML = generateAnalysisHtml(analysis, 'radarChartCanvas');
            
            setTimeout(() => drawRadarChart('radarChartCanvas', analysis.scores, analysis.researcher_name), 0);

            const keywordMapBtn = document.getElementById('show-keyword-map-btn');
            const hasKeywordData = analysis?.keyword_analysis && (analysis.keyword_analysis.word_cloud?.length > 0 || analysis.keyword_analysis.research_trends && Object.keys(analysis.keyword_analysis.research_trends).length > 0);
            keywordMapBtn.style.display = hasKeywordData ? 'inline-block' : 'none';
        }
        
        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’HTMLã«å¤‰æ›
        function convertMarkdownToHtml(text) {
            if (!text) return '';
            return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        // æ–°è¦åˆ†æã‚’å®Ÿè¡Œ
        async function runNewAnalysis(analysisId) {
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            const analysis = savedAnalyses.find(a => a.analysis_id === analysisId);
            if (!analysis) {
                alert('æŒ‡å®šã•ã‚ŒãŸåˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            document.getElementById('researcher-name').value = analysis.researcher_name || '';
            document.getElementById('researchmap-url').value = analysis.researchmap_url || '';
            document.getElementById('analysis-query').value = analysis.query || '';

            // ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // ç¾åœ¨ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ã€ä¿å­˜ãƒœã‚¿ãƒ³ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
            currentAnalysisData = { ...analysis };
        }

        // ç¾åœ¨ã®åˆ†æã‚’ä¿å­˜
        async function saveCurrentAnalysis() {
            if (!currentAnalysisData) {
                alert('ä¿å­˜ã™ã‚‹åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            const now = new Date().toISOString();

            // IDã¨ä½œæˆæ—¥æ™‚ï¿½ï¿½ï¿½ç¢ºå®Ÿã«è¨­å®š
            if (!currentAnalysisData.analysis_id) {
                currentAnalysisData.analysis_id = `analysis_${Date.now()}`;
            }
            if (!currentAnalysisData.created_at || isNaN(new Date(currentAnalysisData.created_at).getTime())) {
                currentAnalysisData.created_at = now;
            }
            currentAnalysisData.updated_at = now;

            const existingIndex = savedAnalyses.findIndex(a => a.analysis_id === currentAnalysisData.analysis_id);

            if (existingIndex !== -1) {
                // æ—¢å­˜ã®åˆ†æã‚’æ›´æ–°
                savedAnalyses[existingIndex] = {
                    ...savedAnalyses[existingIndex], // å¿µã®ãŸã‚å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹
                    ...currentAnalysisData // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã
                };
            } else {
                // æ–°ã—ã„åˆ†æã¨ã—ã¦ä¿å­˜
                savedAnalyses.push(currentAnalysisData);
            }

            localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
            
            const saveBtn = document.getElementById('save-analysis-btn');
            saveBtn.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
            saveBtn.disabled = true;
            await loadSavedAnalyses();
        }

        // ä¿å­˜æ¸ˆã¿åˆ†æä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ãƒ»è¡¨ç¤º
        async function loadSavedAnalyses() {
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]').sort((a, b) => {
                // ç„¡åŠ¹ãªæ—¥ä»˜ã‚’è€ƒæ…®ã—ãŸã‚½ãƒ¼ãƒˆ
                const dateA = new Date(b.created_at).getTime();
                const dateB = new Date(a.created_at).getTime();
                if (isNaN(dateA)) return 1;
                if (isNaN(dateB)) return -1;
                return dateA - dateB;
            });

            const listEl = document.getElementById('saved-analyses-list');
            if (savedAnalyses.length === 0) {
                listEl.innerHTML = '<p>ä¿å­˜æ¸ˆã¿ã®åˆ†æçµæœã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listEl.innerHTML = savedAnalyses.map(analysis => {
                const hasDetails = !!analysis.analysis_result;
                const hasKeywordData = hasDetails && analysis.analysis_result.keyword_analysis && (analysis.analysis_result.keyword_analysis.word_cloud?.length > 0 || (analysis.analysis_result.keyword_analysis.research_trends && Object.keys(analysis.analysis_result.keyword_analysis.research_trends).length > 0));

                // æ—¥ä»˜ã‚’å®‰å…¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
                const formatDate = (dateString) => {
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            return 'N/A';
                        }
                        return date.toLocaleString('ja-JP');
                    } catch (e) {
                        return 'N/A';
                    }
                };
                
                const createdAt = formatDate(analysis.created_at);
                const updatedAt = analysis.updated_at ? formatDate(analysis.updated_at) : null;

                return `
                    <div class="saved-analysis-item">
                        <div class="analysis-header">
                            <div>
                                <h4>${analysis.researcher_name}</h4>
                                <p>æ‰€å±: ${analysis.affiliation || 'ä¸æ˜'}</p>
                                <p>æ¤œç´¢ã‚¯ã‚¨ãƒª: ã€Œ${analysis.query}ã€</p>
                                <p>ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: ${analysis.relevance_score != null ? analysis.relevance_score + '/100' : 'N/A'}</p>
                                <p><b>ä¿å­˜æ—¥æ™‚: ${createdAt}</b></p>
                                ${updatedAt ? `<p><b>æ›´æ–°æ—¥æ™‚: ${updatedAt}</b></p>` : ''}
                            </div>
                            <div class="analysis-buttons">
                                ${hasKeywordData ? `<button class="btn btn-secondary" onclick="showSavedKeywordAnalysis('${analysis.analysis_id}')">ğŸ“Š ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ</button>` : ''}
                                ${hasDetails 
                                    ? `<button class="btn btn-secondary" onclick="viewSavedAnalysis('${analysis.analysis_id}')">ğŸ‘ï¸ è©³ç´°ã‚’è¦‹ã‚‹</button>`
                                    : `<button class="btn btn-primary" onclick="runNewAnalysis('${analysis.analysis_id}')">ğŸ¤– AIè©³ç´°åˆ†æ</button>`
                                }
                                <button class="btn btn-primary" onclick="addAnalysisToProject('${analysis.analysis_id}')">â• ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ </button>
                                <button class="btn btn-secondary" onclick="deleteSavedAnalysis('${analysis.analysis_id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ä¿å­˜æ¸ˆã¿åˆ†æã®è©³ç´°ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
        async function viewSavedAnalysis(analysisId) {
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            const analysis = savedAnalyses.find(a => a.analysis_id === analysisId);
            if (!analysis) return;

            const modal = document.getElementById('analysisModal');
            const modalContent = document.getElementById('modal-analysis-content');
            
            const basicInfoHtml = `<div class="info-item"><span class="info-label">ç ”ç©¶è€…å:</span> ${analysis.researcher_name}</div><div class="info-item"><span class="info-label">æ‰€å±:</span> ${analysis.affiliation || 'N/A'}</div><div class="info-item"><span class="info-label">ResearchMap URL:</span> <a href="${analysis.researchmap_url}" target="_blank">${analysis.researchmap_url}</a></div><div class="info-item"><span class="info-label">æ¤œç´¢ã‚¯ã‚¨ãƒª:</span> ${analysis.query}</div><hr style="margin: 20px 0;">`;
            const analysisHtml = generateAnalysisHtml(analysis.analysis_result, 'modalRadarChartCanvas');
            
            modalContent.innerHTML = basicInfoHtml + analysisHtml;
            
            setTimeout(() => drawRadarChart('modalRadarChartCanvas', analysis.analysis_result?.scores, analysis.analysis_result?.researcher_name), 100);
            
            modal.style.display = 'block';
        }

        // ä¿å­˜æ¸ˆã¿åˆ†æã‚’å‰Šé™¤
        async function deleteSavedAnalysis(analysisId) {
            if (!confirm('ã“ã®åˆ†æçµæœã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
            let savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            savedAnalyses = savedAnalyses.filter(a => a.analysis_id !== analysisId);
            localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
            await loadSavedAnalyses();
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ãƒ•ãƒ­ãƒ¼ã®é–¢æ•°ç¾¤
        function addCurrentAnalysisToProject() {
            if (currentAnalysisData) openProjectSelectModal(currentAnalysisData);
        }
        function addAnalysisToProject(analysisId) {
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            const analysis = savedAnalyses.find(a => a.analysis_id === analysisId);
            if (analysis) openProjectSelectModal(analysis);
        }
        function openProjectSelectModal(analysisData) {
            currentResearcher = {
                name: analysisData.researcher_name,
                affiliation: analysisData.affiliation || 'ä¸æ˜',
                url: analysisData.researchmap_url || '',
                query: analysisData.query || '',
                analysis_score: analysisData.relevance_score,
                has_analysis: !!analysisData.analysis_result
            };
            selectedProjectId = null;
            document.getElementById('project-select-modal').style.display = 'block';
            loadProjectList();
            document.getElementById('add-to-project-btn').disabled = true;
        }
        function closeProjectSelectModal() {
            document.getElementById('project-select-modal').style.display = 'none';
        }
        function loadProjectList() {
            const projects = JSON.parse(localStorage.getItem('tempProjects') || '[]');
            const container = document.getElementById('project-list-container');
            if (projects.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #7f8c8d;"><p>ä»®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`;
                return;
            }
            container.innerHTML = projects.map(p => `
                <div class="project-select-item" onclick="selectProject('${p.id}')">
                    <div class="project-name">${p.name}</div>
                    <div class="project-meta">ç ”ç©¶è€…: ${(p.selected_researchers || []).length}å</div>
                    <div class="project-description">${p.description.substring(0, 100)}...</div>
                </div>`).join('');
        }
        function selectProject(projectId) {
            document.querySelectorAll('.project-select-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.project-select-item').classList.add('selected');
            selectedProjectId = projectId;
            document.getElementById('add-to-project-btn').disabled = false;
        }
        function addResearcherToSelectedProject() {
            if (!currentResearcher || !selectedProjectId) return;
            const projects = JSON.parse(localStorage.getItem('tempProjects') || '[]');
            const project = projects.find(p => p.id === selectedProjectId);
            if (!project) return;
            if (!project.selected_researchers) project.selected_researchers = [];
            if (project.selected_researchers.some(r => r.name === currentResearcher.name)) {
                alert('ã“ã®ç ”ç©¶è€…ã¯æ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            project.selected_researchers.push({ ...currentResearcher, added_at: new Date().toISOString() });
            localStorage.setItem('tempProjects', JSON.stringify(projects));
            alert(`ã€Œ${currentResearcher.name}ã€ã‚’ã€Œ${project.name}ã€ã«è¿½åŠ ã—ã¾ã—ãŸ`);
            closeProjectSelectModal();
        }
        function createNewProjectFromModal() {
            if (currentResearcher) sessionStorage.setItem('pendingResearcher', JSON.stringify(currentResearcher));
            window.location.href = 'project-create.html';
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æé–¢é€£ã®é–¢æ•°
        function showSavedKeywordAnalysis(analysisId) {
            const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
            const analysis = savedAnalyses.find(a => a.analysis_id === analysisId);
            if (analysis) {
                currentAnalysisData = analysis;
                showKeywordAnalysis();
            }
        }

        function showKeywordAnalysis() {
            const keywordData = currentAnalysisData?.analysis_result?.keyword_analysis;
            
            if (keywordData && (keywordData.word_cloud?.length > 0 || (keywordData.research_trends && Object.keys(keywordData.research_trends).length > 0))) {
                const modal = document.getElementById('keyword-map-modal');
                modal.style.display = 'block';
                
                document.getElementById('word-cloud-container').innerHTML = '';
                document.getElementById('trend-chart-container').innerHTML = '';
                document.getElementById('keyword-llm-comment').innerHTML = '';
                document.getElementById('academic-fields-container').innerHTML = '';

                const { academic_fields = [], word_cloud = [], research_trends = {}, llm_comment = '' } = keywordData;
                
                if (academic_fields.length > 0) {
                    let fieldsHtml = '<ul>';
                    academic_fields.forEach(field => {
                        fieldsHtml += `<li><strong>${field.field}:</strong> ${field.description}</li>`;
                    });
                    fieldsHtml += '</ul>';
                    document.getElementById('academic-fields-container').innerHTML = fieldsHtml;
                } else {
                    document.getElementById('academic-fields-container').innerHTML = '<p class="alert alert-info">å­¦å•é ˜åŸŸã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                }

                if (word_cloud.length > 0) {
                    drawWordCloud('word-cloud-container', word_cloud);
                } else {
                    document.getElementById('word-cloud-container').innerHTML = '<p class="alert alert-info">ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                }
                
                if (Object.keys(research_trends).length > 0) {
                    drawResearchTrendChart('trend-chart-container', research_trends);
                } else {
                    document.getElementById('trend-chart-container').innerHTML = '<p class="alert alert-info">ç ”ç©¶ãƒˆãƒ¬ãƒ³ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                }

                if (llm_comment) {
                    document.getElementById('keyword-llm-comment').innerHTML = `<div class="markdown-content">${convertMarkdownToHtml(llm_comment)}</div>`;
                } else {
                    document.getElementById('keyword-llm-comment').innerHTML = '<p class="alert alert-info">AIã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                }
            } else {
                if (confirm('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åˆ†æã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿï¼ˆAPIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™ï¼‰')) {
                    regenerateKeywordAnalysis();
                }
            }
        }

        async function regenerateKeywordAnalysis() {
            if (!currentAnalysisData || !currentAnalysisData.researchmap_url) {
                alert('å†åˆ†æã«å¿…è¦ãªæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const modal = document.getElementById('keyword-map-modal');
            modal.style.display = 'block';
            const loadingHtml = `<div class="loading"><div class="spinner"></div>å†åˆ†æä¸­...</div>`;
            document.getElementById('word-cloud-container').innerHTML = loadingHtml;
            document.getElementById('trend-chart-container').innerHTML = loadingHtml;
            document.getElementById('keyword-llm-comment').innerHTML = loadingHtml;

            try {
                const result = await apiClient.analyzeResearcher(
                    currentAnalysisData.researchmap_url,
                    currentAnalysisData.query,
                    { name_ja: currentAnalysisData.researcher_name },
                    true
                );

                if (result.status !== 'success' || !result.analysis) {
                    throw new Error(result.error || 'å†åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                currentAnalysisData.analysis_result = result.analysis;

                const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
                const analysisIndex = savedAnalyses.findIndex(a => a.analysis_id === currentAnalysisData.analysis_id);
                if (analysisIndex !== -1) {
                    savedAnalyses[analysisIndex] = currentAnalysisData;
                    localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
                }
                
                await loadSavedAnalyses();
                showKeywordAnalysis();

            } catch (error) {
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                closeKeywordMapModal();
            }
        }

        function loadScript(src, callback) {
            if (document.querySelector(`script[src="${src}"]`)) {
                if (callback) callback();
                return;
            }
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            document.head.appendChild(script);
        }

        function closeKeywordMapModal() {
            document.getElementById('keyword-map-modal').style.display = 'none';
        }

        function drawWordCloud(containerId, words) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            const colors = ['#667eea', '#764ba2', '#f39c12', '#16a085', '#c0392b', '#2980b9', '#2c3e50'];
            const width = container.clientWidth;
            const height = container.clientHeight;
            const maxSize = Math.max(...words.map(w => w.size));
            const fontScale = d3.scaleSqrt().domain([0, maxSize]).range([12, Math.min(width, height) / 5]);

            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words.map(d => ({text: d.text, size: fontScale(d.size)})))
                .padding(5)
                .rotate(() => (~~(Math.random() * 6) - 3) * 15)
                .fontSize(d => d.size)
                .on("end", draw);

            layout.start();

            function draw(words) {
                d3.select(`#${containerId}`).append("svg")
                    .attr("width", layout.size()[0])
                    .attr("height", layout.size()[1])
                    .append("g")
                    .attr("transform", `translate(${layout.size()[0] / 2},${layout.size()[1] / 2})`)
                    .selectAll("text")
                    .data(words)
                    .enter().append("text")
                    .style("font-size", d => `${d.size}px`)
                    .style("font-family", "Impact")
                    .style("fill", (d, i) => colors[i % colors.length])
                    .attr("text-anchor", "middle")
                    .attr("transform", d => `translate(${[d.x, d.y]})rotate(${d.rotate})`)
                    .text(d => d.text);
            }
        }

        function drawResearchTrendChart(containerId, trends) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; // Clear previous chart
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            const colors = ['#667eea', '#764ba2', '#f39c12', '#16a085', '#c0392b', '#2980b9', '#2c3e50'];

            const datasets = Object.entries(trends).map(([field, yearData], index) => {
                const color = colors[index % colors.length];
                return {
                    label: field,
                    data: Object.entries(yearData).map(([year, value]) => ({ x: year, y: value })),
                    borderColor: color,
                    backgroundColor: color + '33',
                    fill: false,
                    tension: 0.3
                };
            });
            
            const allYears = [...new Set(datasets.flatMap(d => d.data.map(p => p.x)))].sort();

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allYears,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: value => `${(value * 100).toFixed(0)}%`
                            },
                            title: { display: true, text: 'è«–æ–‡å‰²åˆ' }
                        },
                        x: {
                            title: { display: true, text: 'å¹´' }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.dataset.label}: ${(context.raw.y * 100).toFixed(1)}%`
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
