<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .result-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 600;
            margin: 5px 0;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        
        pre {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ</h2>
        <p>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ãŸåŸºæœ¬æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ</p>
        
        <button class="btn btn-primary" onclick="testLocalStorage()">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button class="btn btn-secondary" onclick="clearLocalStorage()">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        
        <div id="localStorage-result" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸš€ 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ</h2>
        <p>ä»®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ</p>
        
        <button class="btn btn-primary" onclick="testProjectCreation()">ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
        <button class="btn btn-primary" onclick="viewCreatedProjects()">ä½œæˆæ¸ˆã¿ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤º</button>
        
        <div id="project-creation-result" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ‘¨â€ğŸ”¬ 3. ç ”ç©¶è€…è¿½åŠ ãƒ†ã‚¹ãƒˆ</h2>
        <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ç ”ç©¶è€…è¿½åŠ æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ</p>
        
        <button class="btn btn-primary" onclick="testResearcherAddition()">ãƒ†ã‚¹ãƒˆç ”ç©¶è€…è¿½åŠ </button>
        <button class="btn btn-secondary" onclick="viewSelectedResearchers()">é¸æŠæ¸ˆã¿ç ”ç©¶è€…è¡¨ç¤º</button>
        
        <div id="researcher-addition-result" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“¤ 4. ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼ãƒ†ã‚¹ãƒˆ</h2>
        <p>ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼é€ä¿¡æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ</p>
        
        <button class="btn btn-primary" onclick="testMatchingRequest()">ãƒ†ã‚¹ãƒˆãƒãƒƒãƒãƒ³ã‚°ä¾é ¼</button>
        <button class="btn btn-secondary" onclick="checkProjectStatus()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</button>
        
        <div id="matching-request-result" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”— 5. APIçµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <p>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¨ã®é€£æºãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</p>
        
        <button class="btn btn-primary" onclick="testAPIIntegration()">APIçµ±åˆãƒ†ã‚¹ãƒˆ</button>
        <button class="btn btn-secondary" onclick="testAPIFallback()">ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
        
        <div id="api-integration-result" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”„ 6. ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <p>å…¨æ©Ÿèƒ½ã‚’é †ç•ªã«ãƒ†ã‚¹ãƒˆã™ã‚‹çµ±åˆãƒ†ã‚¹ãƒˆ</p>
        
        <button class="btn btn-primary" onclick="runFullIntegrationTest()">ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        
        <div id="full-integration-result" class="result-box" style="display: none;"></div>
    </div>

    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <script src="js/project-manager.js"></script>
    <script>
        // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿
        const testProjectData = {
            name: 'ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ - AIææ–™æ¢ç´¢',
            description: 'äººå·¥çŸ¥èƒ½ã‚’æ´»ç”¨ã—ãŸæ¬¡ä¸–ä»£ææ–™ã®æ¢ç´¢ãƒ»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€‚æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç”¨ã„ã¦æ–°ã—ã„ææ–™ç‰¹æ€§ã‚’äºˆæ¸¬ã—ã€å®Ÿé¨“ã«ã‚ˆã‚‹æ¤œè¨¼ã‚’è¡Œã†ã€‚',
            budget: 5000,
            duration: 18,
            requirements: 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’ã®å°‚é–€çŸ¥è­˜ã€ææ–™ç§‘å­¦ã®åŸºç¤çŸ¥è­˜ã€Python/TensorFlowã®å®Ÿç”¨çµŒé¨“',
            keywords: 'AI, æ©Ÿæ¢°å­¦ç¿’, ææ–™ç§‘å­¦, æ·±å±¤å­¦ç¿’, ææ–™è¨­è¨ˆ'
        };

        const testResearchers = [
            {
                name: 'ãƒ†ã‚¹ãƒˆç ”ç©¶è€…A',
                affiliation: 'ãƒ†ã‚¹ãƒˆå¤§å­¦ å·¥å­¦éƒ¨',
                url: 'https://test-researchmap.jp/researcher-a'
            },
            {
                name: 'ãƒ†ã‚¹ãƒˆç ”ç©¶è€…B', 
                affiliation: 'ãƒ†ã‚¹ãƒˆç ”ç©¶æ‰€',
                url: 'https://test-researchmap.jp/researcher-b'
            }
        ];

        // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ
        function testLocalStorage() {
            const resultDiv = document.getElementById('localStorage-result');
            resultDiv.style.display = 'block';
            
            try {
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const testData = { test: 'ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ', timestamp: new Date().toISOString() };
                localStorage.setItem('project-test', JSON.stringify(testData));
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
                const retrievedData = JSON.parse(localStorage.getItem('project-test'));
                
                if (retrievedData && retrievedData.test === 'ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ') {
                    resultDiv.innerHTML = `
                        <div class="status status-success">âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆæˆåŠŸ</div>
                        <pre>${JSON.stringify(retrievedData, null, 2)}</pre>
                    `;
                } else {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šã«å¤±æ•—');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆå¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('tempProjects');
            localStorage.removeItem('project-test');
            localStorage.removeItem('current_user_id');
            alert('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ
        async function testProjectCreation() {
            const resultDiv = document.getElementById('project-creation-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="status">ğŸ”„ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆä¸­...</div>';
            
            try {
                const project = await window.projectManager.createTempProject(testProjectData);
                
                resultDiv.innerHTML = `
                    <div class="status status-success">âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ</div>
                    <p><strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID:</strong> ${project.id}</p>
                    <p><strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå:</strong> ${project.name}</p>
                    <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${project.status}</p>
                    <p><strong>ä½œæˆæ—¥æ™‚:</strong> ${project.created_at}</p>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        async function viewCreatedProjects() {
            const resultDiv = document.getElementById('project-creation-result');
            resultDiv.style.display = 'block';
            
            try {
                const projects = await window.projectManager.getTempProjects();
                
                if (projects.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="status status-warning">âš ï¸ ä½œæˆæ¸ˆã¿ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
                    `;
                } else {
                    let html = `<div class="status status-success">âœ… ${projects.length}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>`;
                    projects.forEach((project, index) => {
                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 6px;">
                                <h4>${index + 1}. ${project.name}</h4>
                                <p>ID: ${project.id}</p>
                                <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${project.status}</p>
                                <p>ç ”ç©¶è€…: ${(project.selected_researchers || []).length}å</p>
                            </div>
                        `;
                    });
                    resultDiv.innerHTML = html;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        // 3. ç ”ç©¶è€…è¿½åŠ ãƒ†ã‚¹ãƒˆ
        async function testResearcherAddition() {
            const resultDiv = document.getElementById('researcher-addition-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="status">ğŸ”„ ç ”ç©¶è€…è¿½åŠ ä¸­...</div>';
            
            try {
                // ã¾ãšãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                const projects = await window.projectManager.getTempProjects();
                let targetProject;
                
                if (projects.length === 0) {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆã¯ä½œæˆ
                    targetProject = await window.projectManager.createTempProject(testProjectData);
                } else {
                    targetProject = projects[projects.length - 1];
                }
                
                let successCount = 0;
                
                // ãƒ†ã‚¹ãƒˆç ”ç©¶è€…ã‚’è¿½åŠ 
                for (const researcher of testResearchers) {
                    const success = await window.projectManager.addResearcherToTempProject(targetProject.id, researcher);
                    if (success) successCount++;
                }
                
                resultDiv.innerHTML = `
                    <div class="status status-success">âœ… ç ”ç©¶è€…è¿½åŠ ãƒ†ã‚¹ãƒˆå®Œäº†</div>
                    <p><strong>å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</strong> ${targetProject.name}</p>
                    <p><strong>è¿½åŠ æˆåŠŸ:</strong> ${successCount}/${testResearchers.length}å</p>
                    <p><strong>è¿½åŠ ã—ãŸç ”ç©¶è€…:</strong></p>
                    <ul>
                        ${testResearchers.map(r => `<li>${r.name} (${r.affiliation})</li>`).join('')}
                    </ul>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ç ”ç©¶è€…è¿½åŠ å¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        async function viewSelectedResearchers() {
            const resultDiv = document.getElementById('researcher-addition-result');
            resultDiv.style.display = 'block';
            
            try {
                const projects = await window.projectManager.getTempProjects();
                if (projects.length === 0) {
                    resultDiv.innerHTML = `<div class="status status-warning">âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                    return;
                }
                
                const latestProject = projects[projects.length - 1];
                const researchers = latestProject.selected_researchers || [];
                
                if (researchers.length === 0) {
                    resultDiv.innerHTML = `<div class="status status-warning">âš ï¸ é¸æŠæ¸ˆã¿ç ”ç©¶è€…ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
                } else {
                    let html = `<div class="status status-success">âœ… ${researchers.length}åã®ç ”ç©¶è€…ãŒé¸æŠæ¸ˆã¿</div>`;
                    researchers.forEach((researcher, index) => {
                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                ${index + 1}. ${researcher.name} (${researcher.affiliation})
                                <br><small>è¿½åŠ æ—¥: ${new Date(researcher.added_at).toLocaleString()}</small>
                            </div>
                        `;
                    });
                    resultDiv.innerHTML = html;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ç ”ç©¶è€…å–å¾—å¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        // 4. ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼ãƒ†ã‚¹ãƒˆ
        async function testMatchingRequest() {
            const resultDiv = document.getElementById('matching-request-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="status">ğŸ”„ ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼é€ä¿¡ä¸­...</div>';
            
            try {
                const projects = await window.projectManager.getTempProjects();
                if (projects.length === 0) {
                    throw new Error('ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const latestProject = projects[projects.length - 1];
                const testMessage = `ãƒ†ã‚¹ãƒˆãƒãƒƒãƒãƒ³ã‚°ä¾é ¼

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${latestProject.name}ã€ã«é–¢ã—ã¦ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã€‘
${latestProject.description}

ã€æœŸé–“ã€‘${latestProject.duration}ãƒ¶æœˆ
ã€äºˆç®—ã€‘${latestProject.budget}ä¸‡å††

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
                
                const result = await window.projectManager.sendMatchingRequest(latestProject.id, testMessage, 'normal');
                
                if (result.status === 'success') {
                    resultDiv.innerHTML = `
                        <div class="status status-success">âœ… ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼é€ä¿¡æˆåŠŸ</div>
                        <p><strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</strong> ${latestProject.name}</p>
                        <p><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${testMessage.substring(0, 100)}...</p>
                        ${result.fallback ? '<p><small>â€» ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ</small></p>' : ''}
                    `;
                } else {
                    throw new Error(result.message || 'ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼å¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        async function checkProjectStatus() {
            const resultDiv = document.getElementById('matching-request-result');
            resultDiv.style.display = 'block';
            
            try {
                const projects = await window.projectManager.getTempProjects();
                
                let html = `<div class="status status-success">âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§</div>`;
                projects.forEach((project, index) => {
                    const statusText = {
                        'draft': 'ä½œæˆä¸­',
                        'active': 'é€²è¡Œä¸­',
                        'matching_requested': 'ä¾é ¼é€ä¿¡æ¸ˆã¿',
                        'completed': 'å®Œäº†'
                    }[project.status] || project.status;
                    
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                            <strong>${project.name}</strong><br>
                            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusText}<br>
                            ç ”ç©¶è€…æ•°: ${(project.selected_researchers || []).length}å<br>
                            æœ€çµ‚æ›´æ–°: ${project.updated_at ? new Date(project.updated_at).toLocaleString() : 'æœªæ›´æ–°'}
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        // 5. APIçµ±åˆãƒ†ã‚¹ãƒˆ
        async function testAPIIntegration() {
            const resultDiv = document.getElementById('api-integration-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="status">ğŸ”„ APIçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            try {
                // APIå¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯
                const apiAvailable = await window.projectManager.checkAPIAvailability();
                
                if (apiAvailable) {
                    resultDiv.innerHTML = `
                        <div class="status status-success">âœ… APIçµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ</div>
                        <p>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒåˆ©ç”¨å¯èƒ½ã§ã™</p>
                        <p>API URL: ${window.apiClient.getCurrentApiUrl()}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status status-warning">âš ï¸ APIåˆ©ç”¨ä¸å¯</div>
                        <p>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚</p>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ APIçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        async function testAPIFallback() {
            const resultDiv = document.getElementById('api-integration-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="status">ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            try {
                // å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
                const originalUseAPI = window.projectManager.useAPI;
                window.projectManager.useAPI = false;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                const project = await window.projectManager.createTempProject({
                    name: 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                    description: 'APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ'
                });
                
                // å…ƒã®è¨­å®šã«æˆ»ã™
                window.projectManager.useAPI = originalUseAPI;
                
                resultDiv.innerHTML = `
                    <div class="status status-success">âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸ</div>
                    <p>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã—ãŸ</p>
                    <p>ä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${project.name}</p>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¤±æ•—</div>
                    <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        // 6. ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆ
        async function runFullIntegrationTest() {
            const resultDiv = document.getElementById('full-integration-result');
            resultDiv.style.display = 'block';
            
            const steps = [
                '1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢',
                '2. APIå¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯',
                '3. ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ',
                '4. ç ”ç©¶è€…è¿½åŠ ',
                '5. ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼é€ä¿¡',
                '6. çµæœæ¤œè¨¼'
            ];
            
            let currentStep = 0;
            let results = [];
            
            try {
                // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
                resultDiv.innerHTML = `<div class="status">ğŸ”„ ${steps[currentStep]}</div>`;
                localStorage.removeItem('tempProjects');
                localStorage.removeItem('current_user_id');
                results.push('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢å®Œäº†');
                currentStep++;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: APIå¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯
                resultDiv.innerHTML = `<div class="status">ğŸ”„ ${steps[currentStep]}</div>`;
                const apiAvailable = await window.projectManager.checkAPIAvailability();
                results.push(`${apiAvailable ? 'âœ…' : 'âš ï¸'} APIå¯ç”¨æ€§: ${apiAvailable ? 'åˆ©ç”¨å¯èƒ½' : 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰'}`);
                currentStep++;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                resultDiv.innerHTML = `<div class="status">ğŸ”„ ${steps[currentStep]}</div>`;
                const project = await window.projectManager.createTempProject(testProjectData);
                results.push(`âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: ${project.name} (${project.id})`);
                currentStep++;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ã‚¹ãƒ†ãƒƒãƒ—4: ç ”ç©¶è€…è¿½åŠ 
                resultDiv.innerHTML = `<div class="status">ğŸ”„ ${steps[currentStep]}</div>`;
                let addedResearchers = 0;
                for (const researcher of testResearchers) {
                    const success = await window.projectManager.addResearcherToTempProject(project.id, researcher);
                    if (success) addedResearchers++;
                }
                results.push(`âœ… ç ”ç©¶è€…è¿½åŠ : ${addedResearchers}/${testResearchers.length}å`);
                currentStep++;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ã‚¹ãƒ†ãƒƒãƒ—5: ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼é€ä¿¡
                resultDiv.innerHTML = `<div class="status">ğŸ”„ ${steps[currentStep]}</div>`;
                const testMessage = `ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆç”¨ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼\n\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${project.name}\nå®Ÿè¡Œæ—¥æ™‚: ${new Date().toLocaleString()}`;
                const matchingResult = await window.projectManager.sendMatchingRequest(project.id, testMessage, 'normal');
                results.push(`âœ… ãƒãƒƒãƒãƒ³ã‚°ä¾é ¼: ${matchingResult.status === 'success' ? 'é€ä¿¡æˆåŠŸ' : 'é€ä¿¡å¤±æ•—'}`);
                currentStep++;
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ã‚¹ãƒ†ãƒƒãƒ—6: çµæœæ¤œè¨¼
                resultDiv.innerHTML = `<div class="status">ğŸ”„ ${steps[currentStep]}</div>`;
                const finalProjects = await window.projectManager.getTempProjects();
                const finalProject = finalProjects.find(p => p.id === project.id);
                
                const verification = {
                    projectExists: !!finalProject,
                    hasResearchers: finalProject ? (finalProject.selected_researchers || []).length > 0 : false,
                    statusUpdated: finalProject ? finalProject.status === 'matching_requested' : false
                };
                
                results.push(`âœ… æ¤œè¨¼å®Œäº†: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå­˜åœ¨=${verification.projectExists}, ç ”ç©¶è€…=${verification.hasResearchers}, ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=${verification.statusUpdated}`);
                
                // æœ€çµ‚çµæœè¡¨ç¤º
                const allSuccessful = results.every(r => r.startsWith('âœ…'));
                
                resultDiv.innerHTML = `
                    <div class="status ${allSuccessful ? 'status-success' : 'status-warning'}">
                        ${allSuccessful ? 'ğŸ‰ ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆå®Œå…¨æˆåŠŸï¼' : 'âš ï¸ ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆéƒ¨åˆ†çš„æˆåŠŸ'}
                    </div>
                    <h4>ãƒ†ã‚¹ãƒˆçµæœè©³ç´°:</h4>
                    <ul>
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    <h4>ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:</h4>
                    <pre>${JSON.stringify({
                        project: {
                            id: project.id,
                            name: project.name,
                            status: finalProject ? finalProject.status : 'unknown',
                            researchers: finalProject ? (finalProject.selected_researchers || []).length : 0
                        },
                        verification: verification
                    }, null, 2)}</pre>
                `;
                
            } catch (error) {
                results.push(`âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`);
                
                resultDiv.innerHTML = `
                    <div class="status status-error">âŒ ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—</div>
                    <p><strong>å¤±æ•—ã‚¹ãƒ†ãƒƒãƒ—:</strong> ${steps[currentStep]}</p>
                    <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
                    <h4>ã“ã“ã¾ã§ã®çµæœ:</h4>
                    <ul>
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                `;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ§ª ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ã‚’å¾…ã¤
            let retryCount = 0;
            while (!window.projectManager && retryCount < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retryCount++;
            }
            
            // ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
            const dependencies = {
                'config.js': typeof window.config !== 'undefined',
                'api-client.js': typeof window.apiClient !== 'undefined',
                'project-manager.js': typeof window.projectManager !== 'undefined'
            };
            
            console.log('ğŸ“¦ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯:', dependencies);
            
            const missingDeps = Object.keys(dependencies).filter(dep => !dependencies[dep]);
            if (missingDeps.length > 0) {
                document.body.insertAdjacentHTML('afterbegin', `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>âš ï¸ ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼</h3>
                        <p>ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“:</p>
                        <ul>${missingDeps.map(dep => `<li>${dep}</li>`).join('')}</ul>
                        <p>ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€å¿…è¦ãªJavaScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `);
            } else {
                document.body.insertAdjacentHTML('afterbegin', `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>âœ… åˆæœŸåŒ–å®Œäº†</h3>
                        <p>ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
                    </div>
                `);
            }
        });
    </script>
</body>
</html>
