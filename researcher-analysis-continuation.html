            selectedProjectId = projectId;
            
            // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('add-to-project-btn').disabled = false;
        }

        // é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç ”ç©¶è€…ã‚’è¿½åŠ 
        function addResearcherToSelectedProject() {
            if (!currentResearcher || !selectedProjectId) {
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                const tempProjects = JSON.parse(localStorage.getItem('tempProjects') || '[]');
                const project = tempProjects.find(p => p.id === selectedProjectId);
                
                if (!project) {
                    alert('é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ç ”ç©¶è€…æƒ…å ±ã‚’æ•´ç†
                const researcherData = {
                    name: currentResearcher.name,
                    affiliation: currentResearcher.affiliation,
                    url: currentResearcher.url || '',
                    query: currentResearcher.query || '',
                    added_at: new Date().toISOString(),
                    analysis_score: currentResearcher.analysis_score,
                    has_analysis: currentResearcher.has_analysis || false
                };
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (!project.selected_researchers) {
                    project.selected_researchers = [];
                }
                
                const exists = project.selected_researchers.some(r => r.name === researcherData.name);
                if (exists) {
                    alert('ã“ã®ç ”ç©¶è€…ã¯æ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™');
                    return;
                }
                
                // ç ”ç©¶è€…ã‚’è¿½åŠ 
                project.selected_researchers.push(researcherData);
                project.updated_at = new Date().toISOString();
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('tempProjects', JSON.stringify(tempProjects));
                
                alert(`ã€Œ${researcherData.name}ã€ã‚’ã€Œ${project.name}ã€ã«è¿½åŠ ã—ã¾ã—ãŸ`);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeProjectSelectModal();
                
            } catch (error) {
                console.error('ç ”ç©¶è€…è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç ”ç©¶è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        function createNewProjectFromModal() {
            // ç ”ç©¶è€…æƒ…å ±ã‚’ä¸€æ™‚ä¿å­˜
            if (currentResearcher) {
                sessionStorage.setItem('pendingResearcher', JSON.stringify(currentResearcher));
            }
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆç”»é¢ã«é·ç§»
            window.location.href = 'project-create.html';
        }
        
        // AIè©³ç´°åˆ†æã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
        async function runDetailedAnalysis(analysisId) {
            try {
                // ä¿å­˜æ¸ˆã¿åˆ†æã‚’å–å¾—
                const savedAnalyses = JSON.parse(localStorage.getItem('researchAnalyses') || '[]');
                const analysis = savedAnalyses.find(a => a.analysis_id === analysisId);
                
                if (!analysis) {
                    alert('åˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // å¿…è¦ãªæƒ…å ±ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!analysis.researchmap_url || !analysis.query) {
                    alert('AIè©³ç´°åˆ†æã«å¿…è¦ãªæƒ…å ±ï¼ˆResearchMap URLã¾ãŸã¯æ¤œç´¢ã‚¯ã‚¨ãƒªï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                    return;
                }
                
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const button = event.target;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = 'ğŸ”„ åˆ†æå®Ÿè¡Œä¸­...';
                
                // APIå‘¼ã³å‡ºã—
                const response = await fetch(`${apiClient.baseURL}/api/analyze-researcher`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        researchmap_url: researchmapUrl,
                        query: query,
                        include_keyword_map: true, // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã®ç”Ÿæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                        researcher_basic_info: {
                            name_ja: researcherName
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success' && result.analysis) {
                    // åˆ†æçµæœã‚’æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«çµ±åˆ
                    analysis.analysis_result = result.analysis;
                    analysis.relevance_score = result.analysis.scores?.total || analysis.relevance_score;
                    analysis.affiliation = result.analysis.affiliation || analysis.affiliation;
                    analysis.updated_at = new Date().toISOString();
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    localStorage.setItem('researchAnalyses', JSON.stringify(savedAnalyses));
                    
                    alert('âœ… AIè©³ç´°åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    
                    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    await loadSavedAnalyses();
                    
                } else {
                    throw new Error(result.error || 'AIè©³ç´°åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('AIè©³ç´°åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ AIè©³ç´°åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                const button = event.target;
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>